<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Boys Shows</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#111; --fg:#eee; --accent:#f0c000;
      --block-show:#333; --block-season:#444; --block-item:#555;
      --blue:#4ea3ff; --green:#35c46d; --white:#fff; --red:#ff5c5c;
    }
    * { box-sizing:border-box }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      padding: 16px;
      line-height: 1.35;
    }
    h1 { text-align:center; color:var(--accent); margin:8px 0 16px; }

    /* Controls */
    .controls {
      display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center;
      background:#1a1a1a; border:1px solid #444; padding:10px; margin-bottom:14px;
    }
    .controls label { display:flex; align-items:center; gap:6px; cursor:pointer }
    .btn { padding:6px 10px; border:1px solid #555; background:#222; color:var(--fg); border-radius:4px; cursor:pointer }
    .btn:hover { background:#2a2a2a }

    /* Sections */
    details { margin-bottom:12px; border:1px solid #444; background:#222; }
    summary { cursor:pointer; font-weight:bold; color:var(--accent); padding:10px 12px; user-select:none }
    .block-show { background:var(--block-show); }
    .block-season { background:var(--block-season); }
    .block-item { background:var(--block-item); }
    .title-show { color:var(--blue); }
    .title-season { color:var(--green); }
    .title-item { color:var(--white); }

    /* Flex “tables” */
    .flex-table { display:grid; gap:6px; padding:8px 12px; align-items:start }
    .cell { padding:6px 8px; border:1px solid #555; background:#1a1a1a; min-width:0 }
    .flex-header .cell { background:#222; color:var(--accent); font-weight:bold }
    .cell:hover { background:#333 }

    /* Layouts */
    .flex-table.show    { grid-template-columns: 120px 1fr 140px 140px 120px 1fr; }
    .flex-table.season  { grid-template-columns: 100px 120px 1fr 200px; }
    .flex-table.episodes{ grid-template-columns: 60px 220px 140px 1fr 110px 260px 220px; }
    .flex-table.movies  { grid-template-columns: 120px 220px 1fr 140px 100px 110px 260px 220px; }

    /* Icons and links */
    .icons { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .icon-link {
      display:flex; align-items:center; gap:6px;
      border:1px solid #555; background:#222; color:var(--fg);
      border-radius:4px; padding:4px 8px; text-decoration:none; font-size:0.9em;
    }
    .icon-link:hover { background:#2a2a2a }
    .logo { width:18px; height:18px; display:inline-block }

    /* Status */
    .status-watched { color:var(--green); font-weight:bold }
    .status-watching { color:var(--blue); font-weight:bold }
    .status-none { color:var(--red); font-weight:bold }

    /* Error */
    .error { color:var(--red); padding:8px 12px; background:#1a1a1a; border:1px solid #444; margin-top:8px }
  </style>
</head>
<body>

<h1>The Boys Shows</h1>

<div class="controls">
  <label><input type="checkbox" id="hideComplete"> Hide complete (✅ watched)</label>
  <label><input type="checkbox" id="watchingOnly"> Watching only (⏳)</label>
  <button class="btn" id="collapseAll">Collapse all</button>
  <button class="btn" id="expandAll">Expand all</button>
  <button class="btn" id="clearStatuses">Clear statuses</button>
</div>

<details class="block-show" id="showsSection">
  <summary>+/- Shows</summary>
  <div id="shows"></div>
</details>

<details class="block-item" id="moviesSection">
  <summary>+/- Movies</summary>
  <div id="movies"></div>
</details>

<div id="errors"></div>

<script>
/* Data source */
const DATA_URL = 'https://raw.githubusercontent.com/AJPnKW/IPTV_Data_Harmonization_System/main/docs/show_and_movie_data.tile.txt';

/* Provider link builders */
const linkBuilders = {
  tmdbShow: id => `https://www.themoviedb.org/tv/${id}`,
  tmdbMovie: id => `https://www.themoviedb.org/movie/${id}`,
  vidjoyTv: (id,s,e) => `https://vidjoy.pro/embed/tv/${id}/${s}/${e}`,
  vidjoyMovie: id => `https://vidjoy.pro/embed/movie/${id}`,
  vidsrcTv: (id,s,e) => `https://vidsrc.net/embed/tv/${id}/${s}/${e}`,
  vidsrcMovie: id => `https://vidsrc.net/embed/movie/${id}`,
  mappleTv: (id,s,e) => `https://mapple.tv/watch/tv/${id}/${s}/${e}`,
  mappleMovie: id => `https://mapple.tv/watch/movie/${id}`,
  nunflixTv: (id,s,e) => `https://nunflix.cc/watch/tv/${id}/${s}/${e}`,
  nunflixMovie: id => `https://nunflix.cc/watch/movie/${id}`
};

/* Branded SVG icons (inline, self-contained) */
const icons = {
  tmdb:   `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" rx="3" fill="#01d277"/><path d="M4 5h10v8H4z" fill="#0b3"/><circle cx="9" cy="9" r="3" fill="#fff"/></svg>`,
  vidjoy: `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" rx="3" fill="#222"/><polygon points="6,4 14,9 6,14" fill="#e91e63"/></svg>`,
  vidsrc: `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" rx="3" fill="#333"/><rect x="4" y="5" width="10" height="8" fill="#00bcd4"/><rect x="4" y="13" width="10" height="2" fill="#555"/></svg>`,
  mapple: `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" rx="3" fill="#2e7d32"/><path d="M9 3c2 2 4 2 5 4-2 1-3 3-5 6-2-3-3-5-5-6 1-2 3-2 5-4z" fill="#a5d6a7"/></svg>`,
  nunflix:`<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" rx="3" fill="#111"/><path d="M5 2h3l5 14h-3z" fill="#c2185b"/></svg>`,
  netflix:`<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" fill="#000"/><path d="M5 2h3l5 14h-3z" fill="#E50914"/></svg>`,
  prime:  `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" fill="#232f3e"/><path d="M3 9h12v2H3z" fill="#00a8e1"/><path d="M5 6h8v6H5z" fill="#00a8e1" opacity="0.3"/></svg>`,
  disney: `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="18" fill="#113ccf"/><path d="M4 11c3-5 9-5 10 1" stroke="#fff" stroke-width="2" fill="none"/></svg>`,
  search: `<svg class="logo" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="5" stroke="#eee" stroke-width="2" fill="none"/><line x1="12" y1="12" x2="16" y2="16" stroke="#eee" stroke-width="2"/></svg>`
};

/* Utilities */
function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function keyEpisode(tmdbId, season, ep){ return `status:ep:${tmdbId}:${season}:${ep}` }
function keyMovie(tmdbId){ return `status:mv:${tmdbId}` }
function normalizeStatus(s){ const v=(s||'').toLowerCase(); if(v.includes('watched')) return 'watched'; if(v.includes('watching')) return 'watching'; return 'none'; }
function statusClass(s){ return s==='watched' ? 'status-watched' : s==='watching' ? 'status-watching' : 'status-none' }
function reportError(msg){ const errors=document.getElementById('errors'); const div=document.createElement('div'); div.className='error'; div.textContent=msg; errors.appendChild(div); }
const filters = { hideComplete:false, watchingOnly:false };

/* Data load & robust parse */
async function loadData(){
  let text;
  try{
    const res = await fetch(DATA_URL);
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    text = await res.text();
  }catch(err){
    reportError(`Failed to load data file: ${err.message}`);
    console.error(err);
    return { shows:{}, movies:[] };
  }

  const lines = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));

  const shows = {};
  const movies = [];
  let currentShow = null;
  let currentSeason = null;

  for (let i=0; i<lines.length; i++){
    const line = lines[i];
    const parts = line.split('|').map(p => p.trim());
    const type = parts[0];

    try{
      switch(type){
        case 'show': {
          if (parts.length < 9) throw new Error('show: insufficient fields');
          const [, id, name, overview, date, status, source, schedule, url] = parts;
          currentShow = { id, name, overview, date, status, source, schedule, url, seasons: [] };
          shows[id] = currentShow;
          currentSeason = null;
          break;
        }
        case 'season': {
          if (parts.length < 6) throw new Error('season: insufficient fields');
          const [, showId, seasonNum, year, overview, watchStatus] = parts;
          if (!shows[showId]) throw new Error(`season references unknown showId: ${showId}`);
          currentSeason = { seasonNum, year, overview, watchStatus, episodes: [], showId };
          shows[showId].seasons.push(currentSeason);
          break;
        }
        case 'episode': {
          if (parts.length < 13) throw new Error('episode: insufficient fields');
          const [, showId, epNum, title, date, desc, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus] = parts;
          if (!currentSeason) throw new Error('episode before season');
          if (currentSeason.showId !== showId) console.warn(`Episode showId mismatch at line ${i+1}`);
          currentSeason.episodes.push({ showId, epNum, title, date, desc, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus });
          break;
        }
        case 'movie': {
          if (parts.length < 13) throw new Error('movie: insufficient fields');
          const [, id, name, overview, releaseDate, rating, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus] = parts;
          movies.push({ id, name, overview, releaseDate, rating, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus });
          break;
        }
        default:
          throw new Error(`Unknown type: ${type}`);
      }
    }catch(err){
      console.warn(`Parse warning [line ${i+1}]: ${err.message} | ${line}`);
    }
  }

  console.log('Parsed data:', { shows:Object.keys(shows).length, movies:movies.length });
  return { shows, movies };
}

/* Link element with inline SVG */
function aLink(label, href, svg){
  const a = document.createElement('a');
  a.className = 'icon-link';
  a.href = href;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  if (svg){
    const span = document.createElement('span');
    span.innerHTML = svg;
    a.appendChild(span.firstChild);
  }
  const text = document.createElement('span');
  text.textContent = label;
  a.appendChild(text);
  return a;
}

/* Android TV deep links with web-search fallback for episodes */
function appDeepLinksForEpisode(ep, seasonNum){
  const wrap = document.createElement('div'); wrap.className='icons';
  const title = `${ep.title} S${seasonNum}E${ep.epNum}`;

  const n = aLink('Netflix', `intent://details?titleId=${ep.showId}#Intent;scheme=netflix;package=com.netflix.ninja;end`, icons.netflix);
  n.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Netflix`, '_blank'), 600));
  wrap.appendChild(n);

  const p = aLink('Prime Video', `intent://details?asin=${ep.showId}#Intent;scheme=primevideo;package=com.amazon.avod.thirdpartyclient;end`, icons.prime);
  p.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Prime+Video`, '_blank'), 600));
  wrap.appendChild(p);

  const d = aLink('Disney+', `intent://title/${ep.showId}#Intent;scheme=disneyplus;package=com.disney.disneyplus;end`, icons.disney);
  d.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Disney+Plus`, '_blank'), 600));
  wrap.appendChild(d);

  // General search
  wrap.appendChild(aLink('Search', `https://www.google.com/search?q=${encodeURIComponent(title)}`, icons.search));

  return wrap;
}

/* Android TV deep links with web-search fallback for movies */
function appDeepLinksForMovie(mv){
  const wrap = document.createElement('div'); wrap.className='icons';
  const title = mv.name;

  const n = aLink('Netflix', `intent://details?titleId=${mv.id}#Intent;scheme=netflix;package=com.netflix.ninja;end`, icons.netflix);
  n.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Netflix`, '_blank'), 600));
  wrap.appendChild(n);

  const p = aLink('Prime Video', `intent://details?asin=${mv.id}#Intent;scheme=primevideo;package=com.amazon.avod.thirdpartyclient;end`, icons.prime);
  p.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Prime+Video`, '_blank'), 600));
  wrap.appendChild(p);

  const d = aLink('Disney+', `intent://title/${mv.id}#Intent;scheme=disneyplus;package=com.disney.disneyplus;end`, icons.disney);
  d.addEventListener('click', () => setTimeout(() => window.open(`https://www.google.com/search?q=${encodeURIComponent(title)}+Disney+Plus`, '_blank'), 600));
  wrap.appendChild(d);

  wrap.appendChild(aLink('Search', `https://www.google.com/search?q=${encodeURIComponent(title)}`, icons.search));
  return wrap;
}

/* Status controls */
function statusButtons({ key, initial }){
  const wrap = document.createElement('div'); wrap.className='icons';
  const cur = normalizeStatus(localStorage.getItem(key) || initial);
  const lbl = document.createElement('span'); lbl.className = statusClass(cur); lbl.textContent = cur; wrap.appendChild(lbl);

  const btnWatching = aLink('⏳ watching', '#');
  btnWatching.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.setItem(key,'watching'); lbl.className=statusClass('watching'); lbl.textContent='watching'; });
  const btnWatched = aLink('✅ watched', '#');
  btnWatched.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.setItem(key,'watched'); lbl.className=statusClass('watched'); lbl.textContent='watched'; });
  const btnClear = aLink('❌ unmark', '#');
  btnClear.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem(key); lbl.className=statusClass('none'); lbl.textContent='none'; });

  wrap.appendChild(btnWatching);
  wrap.appendChild(btnWatched);
  wrap.appendChild(btnClear);
  return wrap;
}

/* Filter logic */
function shouldHideByFilters(status){
  const s = normalizeStatus(status);
  if (filters.watchingOnly) return s !== 'watching';
  if (filters.hideComplete) return s === 'watched';
  return false;
}

/* Render: shows, seasons, episodes */
function renderShows(shows){
  const container = document.getElementById('shows');
  container.innerHTML = '';

  Object.values(shows).forEach(show => {
    const showDetails = document.createElement('details');
    showDetails.open = false;
    showDetails.className = 'block-show';
    const showSummary = document.createElement('summary');
    showSummary.innerHTML = `<span class="title-show">${esc(show.name)}</span>`;
    showDetails.appendChild(showSummary);

    // Show header grid
    const sh = document.createElement('div'); sh.className='flex-table show flex-header';
    const shHeaders = ['TMDB ID','Overview','Date','Status','Source','Schedule'];
    const shValues  = [show.id, show.overview, show.date, show.status, show.source, show.schedule];
    shHeaders.forEach((h, i) => {
      const hcell = document.createElement('div'); hcell.className='cell'; hcell.textContent=h; sh.appendChild(hcell);
      const vcell = document.createElement('div'); vcell.className='cell'; vcell.innerHTML=esc(shValues[i] ?? ''); sh.appendChild(vcell);
    });
    showDetails.appendChild(sh);

    // TMDB link row
    const showLinks = document.createElement('div'); showLinks.className='icons';
    const tmdbUrl = show.url ? show.url : linkBuilders.tmdbShow(show.id);
    showLinks.appendChild(aLink('TMDB', tmdbUrl, icons.tmdb));
    showDetails.appendChild(showLinks);

    // Seasons
    show.seasons.forEach(season => {
      const seasonDetails = document.createElement('details');
      seasonDetails.open = false;
      seasonDetails.className = 'block-season';
      const seasonSummary = document.createElement('summary');
      seasonSummary.innerHTML = `<span class="title-season">Season ${esc(season.seasonNum)} (${esc(season.year)}) • ${season.episodes.length} episodes</span>`;
      seasonDetails.appendChild(seasonSummary);

      // Season header
      const seH = document.createElement('div'); seH.className='flex-table season flex-header';
      const seHeaders = ['Season #','Year','Overview','Watch status'];
      const seValues = [season.seasonNum, season.year, season.overview, season.watchStatus];
      seHeaders.forEach((h, idx) => {
        const hcell = document.createElement('div'); hcell.className='cell'; h.textContent=h; hcell.textContent=h; seH.appendChild(hcell);
        const vcell = document.createElement('div'); vcell.className='cell';
        if (idx === 3){
          const sKey = `status:season:${show.id}:${season.seasonNum}`;
          vcell.appendChild(statusButtons({ key: sKey, initial: season.watchStatus }));
        } else {
          vcell.innerHTML = esc(seValues[idx] ?? '');
        }
        seH.appendChild(vcell);
      });
      seasonDetails.appendChild(seH);

      // Episodes grid
      if (season.episodes.length){
        const epGrid = document.createElement('div'); epGrid.className='flex-table episodes';
        ['#','Title','Date','Description','Runtime','Links','Status'].forEach(h => {
          const c = document.createElement('div'); c.className='cell'; c.textContent=h; epGrid.appendChild(c);
        });

        season.episodes.forEach(ep => {
          const statusKey = keyEpisode(ep.showId, season.seasonNum, ep.epNum);
          const cur = normalizeStatus(localStorage.getItem(statusKey) || ep.watchStatus);
          if (shouldHideByFilters(cur)) return;

          [esc(ep.epNum), esc(ep.title), esc(ep.date), esc(ep.desc), esc(ep.runtime)].forEach(v => {
            const c = document.createElement('div'); c.className='cell'; c.innerHTML=v; epGrid.appendChild(c);
          });

          // Links: providers + app deep links
          const linkCell = document.createElement('div'); linkCell.className='cell';
          const linkWrap = document.createElement('div'); linkWrap.className='icons';
          linkWrap.appendChild(aLink('TMDB',   linkBuilders.tmdbShow(ep.showId), icons.tmdb));
          linkWrap.appendChild(aLink('VidJoy', linkBuilders.vidjoyTv(ep.showId, season.seasonNum, ep.epNum), icons.vidjoy));
          linkWrap.appendChild(aLink('VidSrc', linkBuilders.vidsrcTv(ep.showId, season.seasonNum, ep.epNum), icons.vidsrc));
          linkWrap.appendChild(aLink('Mapple', linkBuilders.mappleTv(ep.showId, season.seasonNum, ep.epNum), icons.mapple));
          linkWrap.appendChild(aLink('NunFlix',linkBuilders.nunflixTv(ep.showId, season.seasonNum, ep.epNum), icons.nunflix));
          linkWrap.appendChild(appDeepLinksForEpisode(ep, season.seasonNum));
          linkCell.appendChild(linkWrap);
          epGrid.appendChild(linkCell);

          // Status cell
          const stCell = document.createElement('div'); stCell.className='cell';
          stCell.appendChild(statusButtons({ key: statusKey, initial: ep.watchStatus }));
          epGrid.appendChild(stCell);
        });

        seasonDetails.appendChild(epGrid);
      }

      showDetails.appendChild(seasonDetails);
    });

    container.appendChild(showDetails);
  });
}

/* Render: movies */
function renderMovies(movies){
  const container = document.getElementById('movies');
  container.innerHTML = '';

  const mvGrid = document.createElement('div'); mvGrid.className='flex-table movies';
  ['TMDB ID','Name','Overview','Release','Rating','Runtime','Links','Status'].forEach(h => {
    const c = document.createElement('div'); c.className='cell'; c.textContent=h; mvGrid.appendChild(c);
  });

  movies.forEach(mv => {
    const statusKey = keyMovie(mv.id);
    const cur = normalizeStatus(localStorage.getItem(statusKey) || mv.watchStatus);
    if (shouldHideByFilters(cur)) return;

    [esc(mv.id), esc(mv.name), esc(mv.overview), esc(mv.releaseDate), esc(mv.rating), esc(mv.runtime)].forEach(v => {
      const c = document.createElement('div'); c.className='cell'; c.innerHTML=v; mvGrid.appendChild(c);
    });

    // Links
    const linkCell = document.createElement('div'); linkCell.className='cell';
    const linkWrap = document.createElement('div'); linkWrap.className='icons';
    linkWrap.appendChild(aLink('TMDB',   linkBuilders.tmdbMovie(mv.id), icons.tmdb));
    linkWrap.appendChild(aLink('VidJoy', linkBuilders.vidjoyMovie(mv.id), icons.vidjoy));
    linkWrap.appendChild(aLink('VidSrc', linkBuilders.vidsrcMovie(mv.id), icons.vidsrc));
    linkWrap.appendChild(aLink('Mapple', linkBuilders.mappleMovie(mv.id), icons.mapple));
    linkWrap.appendChild(aLink('NunFlix',linkBuilders.nunflixMovie(mv.id), icons.nunflix));
    linkWrap.appendChild(appDeepLinksForMovie(mv));
    linkCell.appendChild(linkWrap);
    mvGrid.appendChild(linkCell);

    // Status
    const stCell = document.createElement('div'); stCell.className='cell';
    stCell.appendChild(statusButtons({ key: statusKey, initial: mv.watchStatus }));
    mvGrid.appendChild(stCell);
  });

  container.appendChild(mvGrid);
}

/* Controls */
function setAllDetails(open){ document.querySelectorAll('details').forEach(d => d.open = !!open); }
function initControls(){
  const hideComplete = document.getElementById('hideComplete');
  const watchingOnly = document.getElementById('watchingOnly');
  hideComplete.addEventListener('change', ()=>{ filters.hideComplete = hideComplete.checked; refresh(); });
  watchingOnly.addEventListener('change', ()=>{ filters.watchingOnly = watchingOnly.checked; refresh(); });
  document.getElementById('collapseAll').addEventListener('click', ()=> setAllDetails(false));
  document.getElementById('expandAll').addEventListener('click', ()=> setAllDetails(true));
  document.getElementById('clearStatuses').addEventListener('click', ()=>{
    Object.keys(localStorage).forEach(k => { if (k.startsWith('status:')) localStorage.removeItem(k) });
    refresh();
  });
}

/* Refresh from cache (apply filters fast) */
let cache = { shows:{}, movies:[] };
function refresh(){
  document.getElementById('shows').innerHTML = '';
  document.getElementById('movies').innerHTML = '';
  renderShows(cache.shows);
  renderMovies(cache.movies);
}

/* Init */
(async function(){
  try{
    initControls();
    cache = await loadData();
    renderShows(cache.shows);
    renderMovies(cache.movies);
    setAllDetails(false); // collapsed by default
    console.log('Data loaded:', { shows:Object.keys(cache.shows).length, movies:cache.movies.length });
  }catch(err){
    reportError(`Runtime error: ${err.message}`);
    console.error(err);
  }
})();
</script>

</body>
</html>
