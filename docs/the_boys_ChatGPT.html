<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Boys Shows • Dark UI (TBS-DARK-4.3)</title>
<!--
  the_boys_ChatGPT.html
  Dark UI with show→season→episode accordions + QA/diagnostics.
  4.3: Fix for “seasons/episodes not visible after expand”
       - On-demand hydration on show expand
       - Normalize IDs to prevent key mismatches
       - Auto-open first season
       - Show-level chips: Seasons / Episodes counts

  Data Schema (no watchStatus in file):
    show|tmdb_id|name|overview|numSeasons|firstAirDate|status|source|schedule
    season|tmdb_id|seasonNum|year|overview
    episode|tmdb_id|seasonNum|epNum|name|airDate|desc|runtime|source
    movie|tmdb_id|name|overview|releaseDate|rating|runtime|source

  Version: 4.3  |  2025-10-18
-->

<style>
  :root{
    --bg: #111215;
    --panel: #171a1f;
    --panel2:#1c2027;

    --band-show:   #232832;
    --band-season: #2a3140;
    --band-ep:     #30384a;

    --border: #283040;
    --text:   #f3f6fb;
    --muted:  #bcd0e7;

    --showBlue:  #77c0ff;
    --seasonGreen:#8ee08e;

    --ok:#3dde88;
    --info:#4fb6ff;
    --danger:#ff7474;

    --chip:#1f2530;
    --focus:#ffd666;
    --link:#a8d1ff;
    --accent:#7ab9ff;
    --shadow: rgba(0,0,0,.5);
  }

  html,body{ background:var(--bg); color:var(--text); margin:0; font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  .container{ max-width:1200px; margin:24px auto 72px; padding:0 16px; }

  header.app{ margin-bottom:14px; }
  .topline{ display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; justify-content:space-between; }
  h1.title{ margin:0; font-size:clamp(22px,2.6vw,30px); font-weight:900; letter-spacing:.2px; }
  .meta{ margin-top:4px; color:var(--muted); font-size:13px; }
  .version{ font-weight:900; background:rgba(122,185,255,.12); border:1px solid #27486e; color:var(--accent);
            padding:3px 8px; border-radius:999px; }

  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .btn{
    appearance:none; border:1px solid var(--border); background:var(--panel2); color:var(--text);
    padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:800;
  }
  .btn.ticked{ box-shadow:0 0 0 2px rgba(79,182,255,.25) inset; border-color:#61b7ff; }
  .btn:focus{ outline:3px solid var(--focus); outline-offset:2px; }

  /* QA drawer */
  .qa{
    margin-top:12px; background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
  }
  .qa-head{
    display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer;
    background:linear-gradient(180deg, #1a2230, #171f2b); font-weight:900;
  }
  .qa-body{ display:none; padding:10px 12px; }
  .qa.open .qa-body{ display:block; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

  /* Sections (Shows/Movies) */
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-top:16px; }
  .card-strip{
    background:linear-gradient(180deg, #1a2230, #171f2b);
    color:#e9f4ff; padding:12px 14px; display:flex; align-items:center; gap:10px; font-weight:900;
  }
  .chev{
    width:28px; height:28px; display:inline-grid; place-items:center;
    border-radius:6px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.25);
    cursor:pointer; user-select:none; font-weight:900;
  }
  .badge{ margin-left:auto; background:rgba(255,255,255,.08); padding:4px 10px; border-radius:999px; font-weight:800; }
  .card-body{ padding:8px 10px 12px; display:none; }
  .card.open .card-body{ display:block; }

  /* Show block */
  .show{ border:1px solid var(--border); border-radius:12px; overflow:hidden; margin:10px 0; background:var(--panel); }
  .show-head{
    display:grid; grid-template-columns:28px 1fr auto; gap:10px; align-items:center;
    padding:10px 12px; background:var(--band-show); cursor:pointer; border-bottom:1px solid var(--border);
  }
  .show-head .name{ font-weight:900; color:var(--showBlue); }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .chip{ background:var(--chip); color:var(--muted); border:1px solid var(--border);
         padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
  .show-body{ display:none; padding:10px; background:var(--panel2); }

  /* Season block */
  .season{ border:1px solid var(--border); border-radius:10px; overflow:hidden; margin:10px 2px; background:var(--panel); }
  .season-head{
    display:flex; align-items:center; gap:12px; padding:10px 12px; background:var(--band-season);
    cursor:pointer; border-bottom:1px solid var(--border); font-weight:900; color:var(--seasonGreen);
  }
  .season-sub{ margin-left:auto; color:var(--muted); font-weight:700; font-size:13px; }

  /* Grid table */
  .table{ width:100%; border-collapse:separate; border-spacing:0; }
  .thead{ position:sticky; top:0; z-index:1; background:#233047; }
  .row{
    display:grid;
    grid-template-columns: 64px 1.5fr 140px 100px minmax(280px,2fr) 140px 96px 96px 96px 74px 210px;
    align-items:center;
  }
  .head,.cell{
    padding:10px 12px; border-bottom:1px solid var(--border);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .head{ font-weight:900; color:#d7ebff; }
  .tbody .row:nth-child(odd){ background:var(--band-ep); }
  .tbody .row:nth-child(even){ background:#2c3450; }

  .row.movie{ grid-template-columns: 1.7fr 140px 100px minmax(320px,2fr) 150px 96px 96px 96px 74px 210px; }

  .desc{ max-height:1.7em; overflow:hidden; text-overflow:ellipsis; }
  .desc.open{ max-height:none; white-space:normal; }
  .more{ margin-left:8px; font-weight:900; color:var(--link); cursor:pointer; }

  .btn-mini{
    border:1px solid var(--border); background:#212938; color:#e8edf3; border-radius:8px;
    padding:6px 8px; cursor:pointer; font-weight:900; font-size:13px; margin-right:6px;
  }
  .btn-mini.info{ background:rgba(79,182,255,.18); color:var(--info); }
  .btn-mini.ok{   background:rgba(61,222,136,.18); color:var(--ok); }
  .btn-mini.dang{ background:rgba(255,116,116,.18); color:var(--danger); }
  .btn-mini:focus{ outline:3px solid var(--focus); outline-offset:2px; }

  a.link{ color:var(--link); text-decoration:none; border-bottom:1px dotted #77b8ff; }
  a.link:focus{ outline:3px solid var(--focus); outline-offset:2px; }

  body.hide-complete .status-watched{ display:none !important; }
  body.watching-only .row:not(.status-watching){ display:none !important; }

  /* Loading modal (unchanged from 4.2) */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:1000; }
  .modal{ position:fixed; inset:auto 0 0 0; margin:auto; top:10vh; width:min(900px,92vw);
          background:var(--panel2); border:1px solid var(--border); border-radius:14px; box-shadow:0 12px 28px var(--shadow);
          display:none; z-index:1001; }
  .modal.open, .modal-backdrop.open{ display:block; }
  .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px;
               padding:12px 14px; border-bottom:1px solid var(--border); font-weight:900;
               background:linear-gradient(180deg, #1a2230, #171f2b); }
  .modal-body{ padding:10px 14px; }
  .modal-foot{ padding:10px 14px; border-top:1px solid var(--border); display:flex; gap:8px; flex-wrap:wrap; }
  .pill{ background:#1e2634; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; color:#cfe2ff; }
  .log{ background:#0f131c; border:1px solid #24314a; color:#d6e4ff; border-radius:10px; padding:10px; height:240px; overflow:auto;
        font:13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space:pre-wrap; }
  .statgrid{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px; margin:8px 0; }
  .stat{ background:#172033; border:1px solid #2a3a58; border-radius:10px; padding:8px; text-align:center; }
  .stat b{ display:block; font-size:20px; }
  .danger{ color:var(--danger); }
</style>
</head>
<body>
  <div class="container">
    <header class="app">
      <div class="topline">
        <h1 class="title">The Boys Shows</h1>
        <span class="version">TBS-DARK-4.3</span>
      </div>
      <div class="toolbar" role="toolbar">
        <button class="btn" id="btnHideComplete">Hide Complete</button>
        <button class="btn" id="btnWatchingOnly">Watching Only</button>
        <button class="btn" id="btnExpandAll">Expand All</button>
        <button class="btn" id="btnCollapseAll">Collapse All</button>
        <button class="btn" id="btnReload">Reload Data</button>
        <button class="btn" id="btnQA">QA / Stats</button>
      </div>
      <div class="meta" id="dataMeta"></div>
    </header>

    <!-- QA Drawer -->
    <section class="qa" id="qaBox" hidden>
      <div class="qa-head" id="qaHead">▸ QA / Stats</div>
      <div class="qa-body">
        <div id="qaSummary" class="mono"></div>
        <details style="margin-top:10px;">
          <summary><b>Per-show counts</b></summary>
          <div id="qaPerShow" class="mono" style="margin-top:8px;"></div>
        </details>
        <details style="margin-top:10px;">
          <summary><b>Tried data URLs</b></summary>
          <pre id="qaTried" class="mono" style="white-space:pre-wrap;background:#12161f;border:1px solid #2a3448;padding:8px;border-radius:8px;color:#cfdaf0;"></pre>
        </details>
      </div>
    </section>

    <!-- Shows -->
    <section class="card" id="cardShows">
      <div class="card-strip">
        <button class="chev" data-acc="#cardShows">▸</button>
        Shows
        <span class="badge" id="showsCount">0</span>
      </div>
      <div class="card-body" id="shows-root"></div>
    </section>

    <!-- Movies -->
    <section class="card" id="cardMovies">
      <div class="card-strip">
        <button class="chev" data-acc="#cardMovies">▸</button>
        Movies
        <span class="badge" id="moviesCount">0</span>
      </div>
      <div class="card-body" id="movies-root"></div>
    </section>

    <p id="error" style="color:#ff9e9e; margin-top:12px;"></p>
  </div>

  <!-- Reload / Status Modal (same as 4.2) -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal" id="statusModal" role="dialog" aria-modal="true" aria-labelledby="statusTitle">
    <div class="modal-head">
      <div id="statusTitle">Reload status</div>
      <div>
        <span class="pill" id="pillBuild">Build: 4.3</span>
        <span class="pill" id="pillTimer">0 ms</span>
      </div>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:6px;">
        <span>Data source:</span>
        <a id="statusDataUrl" href="#" target="_blank" rel="noopener" class="link">(unknown)</a>
      </div>
      <div class="statgrid">
        <div class="stat"><b id="stShows">0</b>Shows</div>
        <div class="stat"><b id="stMovies">0</b>Movies</div>
        <div class="stat"><b id="stSeasons">0</b>Seasons</div>
        <div class="stat"><b id="stEpisodes">0</b>Episodes</div>
      </div>
      <div id="statusError" class="danger" style="min-height:1.2em;"></div>
      <div class="log" id="statusLog"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="btnCopyReport">Copy report</button>
      <button class="btn" id="btnDownloadDiag">Download diagnostics</button>
      <button class="btn" id="btnOpenData">Open data URL</button>
      <button class="btn" id="btnDumpModel">Dump model JSON</button>
      <button class="btn" id="btnClearState">Clear local watch-state</button>
      <div style="margin-left:auto;"></div>
      <button class="btn" id="btnCloseModal">Close</button>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const APP_VERSION = 'TBS-DARK-4.3';
const DATA_URL   = 'show_and_movie_data.tile.txt';
const NS         = 'ajp.watchstatus';

const links = {
  tmdbShow:   (id)        => `https://www.themoviedb.org/tv/${id}`,
  tmdbMovie:  (id)        => `https://www.themoviedb.org/movie/${id}`,
  vidjoyTv:    (id,s,e)   => `https://vidjoy.pro/embed/tv/${id}/${s}/${e}`,
  vidjoyMovie: (id)       => `https://vidjoy.pro/embed/movie/${id}`,
  vidsrcTv:    (id,s,e)   => `https://vidsrc.net/embed/tv/${id}/${s}/${e}`,
  vidsrcMovie: (id)       => `https://vidsrc.net/embed/movie/${id}`,
  mappleTv:    (id,s,e)   => `https://mapple.tv/watch/tv/${id}/${s}/${e}`,
  mappleMovie: (id)       => `https://mapple.tv/watch/movie/${id}`,
  nunflixTv:   (id,s,e)   => `https://nunflix.cc/watch/tv/${id}/${s}/${e}`,
  nunflixMovie:(id)       => `https://nunflix.cc/watch/movie/${id}`,
  netflix:     (q)        => `https://www.netflix.com/search?q=${encodeURIComponent(q)}`,
  prime:       (q)        => `https://www.primevideo.com/search/ref=atv_sr_sug_?phrase=${encodeURIComponent(q)}`
};

const qs  = (s, r = document) => r.querySelector(s);
const qsa = (s, r = document) => [...r.querySelectorAll(s)];

/* ---------- GLOBAL STATE ---------- */
let gLastModel = null;
let gLastText  = '';
let gLastUsed  = '';
let gLastTried = [];
let gLastDiag  = {};

/* ---------- STATUS MODAL (same as 4.2) ---------- */
const modal = {
  backdrop: null, root: null, logEl: null, errEl: null, urlEl: null,
  st: { shows: null, movies: null, seasons: null, episodes: null },
  pillTimer: null,
  open(){ this.backdrop.classList.add('open'); this.root.classList.add('open'); this.clear(); },
  close(){ this.root.classList.remove('open'); this.backdrop.classList.remove('open'); },
  clear(){ this.logEl.textContent=''; this.errEl.textContent=''; this.st.shows.textContent='0';
          this.st.movies.textContent='0'; this.st.seasons.textContent='0'; this.st.episodes.textContent='0';
          this.urlEl.textContent='(unknown)'; this.urlEl.href='#'; this.pillTimer.textContent='0 ms'; },
  log(line){ this.logEl.textContent += (this.logEl.textContent ? '\n' : '') + line; this.logEl.scrollTop = this.logEl.scrollHeight; },
  setError(msg){ this.errEl.textContent = msg || ''; },
  setUrl(u){ this.urlEl.textContent = u || '(unknown)'; if(u){ this.urlEl.href = u; } },
  setCounts({shows, movies, seasons, episodes}){ this.st.shows.textContent=shows; this.st.movies.textContent=movies; this.st.seasons.textContent=seasons; this.st.episodes.textContent=episodes; },
  setTimer(ms){ this.pillTimer.textContent = `${ms} ms`; }
};

/* ---------- STORAGE HELPERS ---------- */
function keyFor(type, tmdbId, seasonNum = null, epNum = null) {
  let k = `${NS}.${type}.${tmdbId}`;
  if (seasonNum != null) k += `.S${seasonNum}`;
  if (epNum    != null) k += `.E${epNum}`;
  return k;
}
function getStatus(type, tmdbId, seasonNum = null, epNum = null) {
  return localStorage.getItem(keyFor(type, tmdbId, seasonNum, epNum)) || 'none';
}
function setStatus(type, tmdbId, seasonNum, epNum, status) {
  localStorage.setItem(keyFor(type, tmdbId, seasonNum, epNum), status);
}

/* ---------- LOADER (prefer RAW first) ---------- */
async function fetchData(force=false, progress=()=>{}){
  const override = new URLSearchParams(location.search).get('data');
  const baseDir  = location.href.substring(0, location.href.lastIndexOf('/')+1);
  const RAW_HEADS = 'https://raw.githubusercontent.com/AJPnKW/IPTV_Data_Harmonization_System/refs/heads/main/docs/' + DATA_URL;
  const RAW_MAIN  = 'https://raw.githubusercontent.com/AJPnKW/IPTV_Data_Harmonization_System/main/docs/' + DATA_URL;

  const candidates = [
    override, RAW_HEADS, RAW_MAIN,
    baseDir + DATA_URL,
    `/IPTV_Data_Harmonization_System/${DATA_URL}`,
    `/IPTV_Data_Harmonization_System/docs/${DATA_URL}`,
    DATA_URL
  ].filter(Boolean);

  const tried=[];
  for (const url of [...new Set(candidates)]) {
    try{
      progress(`Trying: ${url}`);
      const t0 = performance.now();
      const r = await fetch(url, { cache: force ? 'reload' : 'no-store' });
      const ms = Math.round(performance.now()-t0);
      tried.push(`${url} [${r.status}] (${ms} ms)`); progress(`→ ${r.status} in ${ms} ms`);
      if (r.ok) {
        const txt = await r.text();
        const size = new Blob([txt]).size;
        progress(`Fetched OK (${size} bytes).`);
        if (txt && txt.trim()) return { text: txt, used: url, tried, size, ms };
        progress('Response is empty text.');
      }
    }catch(e){ tried.push(`${url} [ERR]`); progress(`ERR: ${e.message}`); }
  }
  return { text: null, used: null, tried };
}

/* ---------- PARSER (normalize keys) ---------- */
function normId(v){ return String((v ?? '')).trim(); }
function normNum(v){
  if (v === null || v === undefined || v === '') return '';
  const n = parseInt(String(v).trim(), 10);
  return Number.isFinite(n) ? String(n) : String(v).trim();
}

function parseDataFile(text) {
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const shows = new Map();
  const movies = [];
  const seasonsByShow = new Map();

  for (const rawLine of lines) {
    if (!rawLine || rawLine.startsWith('#')) continue;
    const U = rawLine.toUpperCase();
    if (U === 'SHOWS' || U === 'SEASONS' || U === 'EPISODES' || U === 'MOVIES') continue;

    const f = splitPipes(rawLine);
    const kind = (f[0] || '').toLowerCase();

    if (kind === 'show') {
      const [, id0, name, overview, numSeasons, firstAirDate, status, source, schedule] = f;
      const id = normId(id0);
      if (!id) continue;
      shows.set(id, { id, name, overview, numSeasons, firstAirDate, status, source, schedule });

    } else if (kind === 'season') {
      const [, showId0, seasonNum0, year, overview] = f;
      const showId   = normId(showId0);
      const seasonNum= normNum(seasonNum0);
      if (!showId || !seasonNum) continue;
      if (!seasonsByShow.has(showId)) seasonsByShow.set(showId, new Map());
      seasonsByShow.get(showId).set(seasonNum, { showId, seasonNum, year, overview, episodes: [] });

    } else if (kind === 'episode') {
      const [, showId0, sNum0, epNum0, name, airDate, desc, runtime, source] = f;
      const showId = normId(showId0);
      const sNum   = normNum(sNum0);
      const epNum  = normNum(epNum0);
      if (!showId || !sNum || !epNum) { console.warn('Skipping episode with missing keys:', f); continue; }
      if (!seasonsByShow.has(showId)) seasonsByShow.set(showId, new Map());
      if (!seasonsByShow.get(showId).has(sNum)) {
        seasonsByShow.get(showId).set(sNum, { showId, seasonNum: sNum, year: (airDate||'').slice(0,4), overview:'', episodes: [] });
      }
      seasonsByShow.get(showId).get(sNum).episodes.push({ showId, seasonNum: sNum, epNum, name, airDate, desc, runtime, source });

    } else if (kind === 'movie') {
      const [, id0, name, overview, releaseDate, rating, runtime, source] = f;
      const id = normId(id0);
      if (!id) continue;
      movies.push({ id, name, overview, releaseDate, rating, runtime, source });
    }
  }

  return { shows, seasonsByShow, movies };
}

function splitPipes(line) {
  const out = []; let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') { inQ = !inQ; continue; }
    if (ch === '|' && !inQ) { out.push(cur); cur = ''; }
    else cur += ch;
  }
  out.push(cur);
  return out.map(s => s.replace(/\\n/g, '\n').trim());
}

/* ---------- RENDER ---------- */
function renderAll({ shows, seasonsByShow, movies }, usedUrl) {
  qs('#shows-root').innerHTML = '';
  qs('#movies-root').innerHTML = '';
  gLastModel = { shows, seasonsByShow, movies };
  qs('#dataMeta').textContent = `Data: ${usedUrl || '(unknown)'}  •  Build: ${APP_VERSION}`;
  gLastUsed = usedUrl || '';
  renderShowsAndMovies();  // initial render
}

function renderShowsAndMovies() {
  if (!gLastModel) return;
  const { shows, seasonsByShow, movies } = gLastModel;

  const showsRoot = qs('#shows-root');
  const moviesRoot = qs('#movies-root');
  showsRoot.innerHTML = '';
  moviesRoot.innerHTML = '';

  const showList = [...shows.values()].sort((a,b) => (a.name||'').localeCompare(b.name||''));
  for (const show of showList) {
    const seasonsMap = seasonsByShow.get(show.id) || new Map();
    showsRoot.appendChild(renderShow(show, seasonsMap));
  }
  qs('#showsCount').textContent  = String(showList.length);

  qs('#moviesCount').textContent = String(movies.length);
  if (movies.length) {
    const head = document.createElement('div');
    head.className = 'table';
    head.innerHTML = `
      <div class="thead row">
        <div class="head">Title</div><div class="head">Release</div><div class="head">Length</div>
        <div class="head">Overview</div><div class="head">Source</div><div class="head">VidJoy</div>
        <div class="head">VidSrc</div><div class="head">Mapple</div><div class="head">NunFlix</div>
        <div class="head">Status / Apps</div>
      </div>`;
    moviesRoot.appendChild(head);
  }
  for (const m of movies) moviesRoot.appendChild(renderMovie(m));
}

function countShow(seasonsMap){
  const sCount = seasonsMap.size;
  let eCount = 0;
  for (const s of seasonsMap.values()) eCount += (s.episodes||[]).length;
  return { sCount, eCount };
}

function renderShow(show, seasonsMap) {
  const wrap = document.createElement('section');
  wrap.className = 'show';
  wrap.dataset.tmdbId = show.id;

  const { sCount, eCount } = countShow(seasonsMap);

  const chips = [];
  if (show.firstAirDate) chips.push(`<span class="chip">${esc(show.firstAirDate)}</span>`);
  if (show.status)       chips.push(`<span class="chip">${esc(show.status)}</span>`);
  if (show.source)       chips.push(`<span class="chip">${esc(show.source)}</span>`);
  if (show.schedule)     chips.push(`<span class="chip">${esc(show.schedule)}</span>`);
  chips.push(`<span class="chip">Seasons: ${sCount} • Episodes: ${eCount}</span>`);
  chips.push(`<a class="link" href="${links.tmdbShow(show.id)}" target="_blank" rel="noopener">TMDB</a>`);

  wrap.innerHTML = `
    <header class="show-head" tabindex="0" role="button" aria-expanded="false">
      <span class="chev">▸</span>
      <div class="name">${esc(show.name)}</div>
      <div class="chips">${chips.join(' ')}</div>
    </header>
    <div class="show-body body" style="display:none;">
      ${show.overview ? `<p class="overview" style="color:var(--muted); margin:6px 0 10px;">${esc(show.overview)}</p>` : ''}
      <div class="seasons"></div>
    </div>
  `;

  // attach click after HTML exists
  const head = qs('.show-head', wrap);
  head.addEventListener('click', () => onShowToggle(head, wrap, show.id));

  // Pre-render season headers so you *see* them immediately when you open the show
  // (Bodies will still be collapsed.)
  const seasonsRoot = qs('.seasons', wrap);
  const seasonsList = [...seasonsMap.values()].sort((a,b) => parseInt(a.seasonNum,10) - parseInt(b.seasonNum,10));
  for (const s of seasonsList) seasonsRoot.appendChild(renderSeason(show, s));

  return wrap;
}

function onShowToggle(headEl, showWrap, showId){
  // Toggle the show body visibility
  const body = headEl.nextElementSibling;
  const chev = headEl.querySelector('.chev');
  const expanded = headEl.getAttribute('aria-expanded') === 'true';
  headEl.setAttribute('aria-expanded', String(!expanded));
  if (chev) chev.textContent = expanded ? '▸' : '▾';
  if (body) body.style.display = expanded ? 'none' : '';

  // If opening, ensure seasons are hydrated and auto-open the first season
  if (!expanded) {
    ensureShowHydrated(showWrap, showId);

    // auto-open first season
    const firstSeasonHead = qs('.season-head', showWrap);
    if (firstSeasonHead && firstSeasonHead.getAttribute('aria-expanded') !== 'true') {
      toggleSeason(firstSeasonHead);
    }
  }
}

function ensureShowHydrated(showWrap, showId){
  // If the model has seasons but DOM has none, attach them now (defensive)
  const seasonsRoot = qs('.seasons', showWrap);
  if (!seasonsRoot) return;

  const seasonsInDom = qsa(':scope > .seasons > .season', showWrap).length;
  const seasonsMap = gLastModel?.seasonsByShow?.get(showId) || new Map();
  if (seasonsInDom === 0 && seasonsMap.size > 0) {
    console.warn('Hydrating seasons on expand for show', showId);
    const list = [...seasonsMap.values()].sort((a,b)=>parseInt(a.seasonNum,10)-parseInt(b.seasonNum,10));
    for (const s of list) seasonsRoot.appendChild(renderSeason({id:showId}, s));
  }
}

function renderSeason(show, season) {
  const el = document.createElement('article');
  el.className = 'season';
  el.dataset.season = season.seasonNum;

  el.innerHTML = `
    <header class="season-head" tabindex="0" role="button" aria-expanded="false">
      <span class="chev">▸</span>
      <div>Season ${esc(season.seasonNum)} ${season.year?`(${esc(season.year)})`:''}</div>
      <div class="season-sub">${esc(season.overview || '')}</div>
    </header>
    <div class="body" style="display:none;">
      ${renderEpisodeTable(show.id, season)}
    </div>
  `;

  const head = qs('.season-head', el);
  head.addEventListener('click', () => toggleSeason(head));
  return el;
}

function toggleSeason(headEl){
  const body = headEl.nextElementSibling;
  const chev = headEl.querySelector('.chev');
  const expanded = headEl.getAttribute('aria-expanded') === 'true';
  headEl.setAttribute('aria-expanded', String(!expanded));
  if (chev) chev.textContent = expanded ? '▸' : '▾';
  if (body) body.style.display = expanded ? 'none' : '';
}

function renderEpisodeTable(showId, season) {
  const rows = [...(season.episodes||[])]
    .sort((a,b) => parseInt(a.epNum,10) - parseInt(b.epNum,10))
    .map(ep => renderEpisodeRow(showId, season.seasonNum, ep))
    .join('');

  return `
    <div class="table" role="table" aria-label="Episodes">
      <div class="thead row" role="row">
        <div class="head">#</div>
        <div class="head">Title</div>
        <div class="head">Date</div>
        <div class="head">Length</div>
        <div class="head">Description</div>
        <div class="head">Source</div>
        <div class="head">VidJoy</div>
        <div class="head">VidSrc</div>
        <div class="head">Mapple</div>
        <div class="head">NunFlix</div>
        <div class="head">Status / Apps</div>
      </div>
      <div class="tbody">${rows || `<div class="row"><div class="cell" style="grid-column:1/-1;color:var(--muted);">No episodes listed</div></div>`}</div>
    </div>
  `;
}

function renderEpisodeRow(showId, seasonNum, ep) {
  const status = getStatus('episode', showId, seasonNum, ep.epNum);
  const id = `ep-${showId}-${seasonNum}-${ep.epNum}`;
  const vidjoy = links.vidjoyTv(showId, seasonNum, ep.epNum);
  const vidsrc = links.vidsrcTv(showId, seasonNum, ep.epNum);
  const mapple = links.mappleTv(showId, seasonNum, ep.epNum);
  const nun    = links.nunflixTv(showId, seasonNum, ep.epNum);

  const netflix = links.netflix(`${ep.name} ${seasonNum}x${ep.epNum}`);
  const prime   = links.prime(`${ep.name} ${seasonNum}x${ep.epNum}`);

  return `
    <div class="row episode-row status-${status}" id="${id}" data-tmdb-id="${showId}" data-season="${seasonNum}" data-ep="${ep.epNum}">
      <div class="cell">E${esc(ep.epNum)}</div>
      <div class="cell">${esc(ep.name || '')}</div>
      <div class="cell">${esc(ep.airDate || '')}</div>
      <div class="cell">${esc(ep.runtime || '')}</div>
      <div class="cell">
        <span class="desc">${esc(ep.desc || '')}</span>
        <span class="more" data-more="${id}">More</span>
      </div>
      <div class="cell">${esc(ep.source || '')}</div>
      <div class="cell"><a class="link" href="${vidjoy}" target="_blank" rel="noopener">📺 VidJoy</a></div>
      <div class="cell"><a class="link" href="${vidsrc}" target="_blank" rel="noopener">📺 VidSrc</a></div>
      <div class="cell"><a class="link" href="${mapple}" target="_blank" rel="noopener">🌐 Mapple</a></div>
      <div class="cell"><a class="link" href="${nun}"    target="_blank" rel="noopener">🎬 NunFlix</a></div>
      <div class="cell">
        <button class="btn-mini info" data-action="watching" title="⏳ Watching">⏳</button>
        <button class="btn-mini ok"   data-action="watched"  title="✅ Watched">✅</button>
        <button class="btn-mini dang" data-action="none"     title="❌ Unmark">❌</button>
        <a class="btn-mini" href="${netflix}" target="_blank" rel="noopener" title="Search Netflix">🅽</a>
        <a class="btn-mini" href="${prime}"   target="_blank" rel="noopener" title="Search Prime">🅿</a>
      </div>
    </div>
  `;
}

function renderMovie(m) {
  const status = getStatus('movie', m.id, null, null);
  const id = `mov-${m.id}`;

  const vidjoy = links.vidjoyMovie(m.id);
  const vidsrc = links.vidsrcMovie(m.id);
  const mapple = links.mappleMovie(m.id);
  const nun    = links.nunflixMovie(m.id);
  const netflix = links.netflix(m.name);
  const prime   = links.prime(m.name);

  const row = document.createElement('div');
  row.className = `row movie status-${status} movie-row`;
  row.id = id;
  row.dataset.tmdbId = m.id;

  row.innerHTML = `
    <div class="cell"><a class="link" href="${links.tmdbMovie(m.id)}" target="_blank" rel="noopener">${esc(m.name)}</a></div>
    <div class="cell">${esc(m.releaseDate || '')}</div>
    <div class="cell">${esc(m.runtime || '')}</div>
    <div class="cell">
      <span class="desc">${esc(m.overview || '')}</span>
      <span class="more" data-more="${id}">More</span>
    </div>
    <div class="cell">${esc(m.source || '')}</div>
    <div class="cell"><a class="link" href="${vidjoy}" target="_blank" rel="noopener">📺 VidJoy</a></div>
    <div class="cell"><a class="link" href="${vidsrc}" target="_blank" rel="noopener">📺 VidSrc</a></div>
    <div class="cell"><a class="link" href="${mapple}" target="_blank" rel="noopener">🌐 Mapple</a></div>
    <div class="cell"><a class="link" href="${nun}"    target="_blank" rel="noopener">🎬 NunFlix</a></div>
    <div class="cell">
      <button class="btn-mini info" data-action="watching" title="⏳ Watching">⏳</button>
      <button class="btn-mini ok"   data-action="watched"  title="✅ Watched">✅</button>
      <button class="btn-mini dang" data-action="none"     title="❌ Unmark">❌</button>
      <a class="btn-mini" href="${netflix}" target="_blank" rel="noopener" title="Search Netflix">🅽</a>
      <a class="btn-mini" href="${prime}"   target="_blank" rel="noopener" title="Search Prime">🅿</a>
    </div>
  `;
  return row;
}

/* ---------- TOGGLES & QA ---------- */
function toggle(targetEl) {
  const isHeader = targetEl.classList.contains('show-head') || targetEl.classList.contains('season-head');
  if (!isHeader) return;
  const body = targetEl.nextElementSibling;
  const chev = targetEl.querySelector('.chev');
  const expanded = targetEl.getAttribute('aria-expanded') === 'true';
  targetEl.setAttribute('aria-expanded', String(!expanded));
  if (chev) chev.textContent = expanded ? '▸' : '▾';
  if (body) body.style.display = expanded ? 'none' : '';
}
window.toggleSection = function (el) { toggle(el); }; // kept for compatibility
window.toggleComplete = function () { document.body.classList.toggle('hide-complete'); };
window.toggleWatched  = function () { document.body.classList.toggle('watching-only'); };

function buildStats(model){
  const { shows, seasonsByShow, movies } = model;
  const showCount = shows.size;
  const movieCount = movies.length;

  let totalSeasons = 0, totalEpisodes = 0;
  const perShow = [];
  for (const [showId, show] of shows.entries()) {
    const smap = seasonsByShow.get(showId) || new Map();
    const sCount = smap.size;
    let eCount = 0;
    for (const s of smap.values()) eCount += (s.episodes||[]).length;
    totalSeasons += sCount; totalEpisodes += eCount;
    perShow.push({ show: show.name || showId, seasons: sCount, episodes: eCount });
  }
  perShow.sort((a,b)=>a.show.localeCompare(b.show));
  return { showCount, movieCount, totalSeasons, totalEpisodes, perShow };
}

/* ---------- INIT + EVENTS ---------- */
function init() {
  // Modal wiring
  modal.backdrop  = qs('#modalBackdrop');
  modal.root      = qs('#statusModal');
  modal.logEl     = qs('#statusLog');
  modal.errEl     = qs('#statusError');
  modal.urlEl     = qs('#statusDataUrl');
  modal.st.shows  = qs('#stShows');
  modal.st.movies = qs('#stMovies');
  modal.st.seasons= qs('#stSeasons');
  modal.st.episodes=qs('#stEpisodes');
  modal.pillTimer = qs('#pillTimer');
  qs('#pillBuild').textContent = `Build: ${APP_VERSION}`;
  qs('#btnCloseModal').addEventListener('click', ()=> modal.close());
  qs('#btnOpenData').addEventListener('click', ()=> { if (gLastUsed) window.open(gLastUsed, '_blank'); });
  qs('#btnCopyReport').addEventListener('click', ()=>{
    const text = modal.logEl.textContent || '';
    navigator.clipboard.writeText(text + '\n' + (modal.errEl.textContent||'')).catch(()=>{});
  });
  qs('#btnDownloadDiag').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(gLastDiag||{}, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `diag_${Date.now()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  });
  qs('#btnDumpModel').addEventListener('click', ()=>{
    const obj = {
      used: gLastUsed, tried: gLastTried,
      shows: [...(gLastModel?.shows||new Map()).values()],
      seasons: Object.fromEntries(
        [...(gLastModel?.seasonsByShow||new Map()).entries()]
          .map(([k,v])=>[k,[...v.values()]])
      ),
      movies: gLastModel?.movies || []
    };
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `model_${Date.now()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  });
  qs('#btnClearState').addEventListener('click', ()=>{
    const keys = Object.keys(localStorage).filter(k=>k.startsWith(NS+'.'));
    keys.forEach(k=>localStorage.removeItem(k));
    alert(`Cleared ${keys.length} local watch-state key(s).`);
  });

  // Card accordions collapsed by default
  qsa('.card .card-strip .chev').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const card = qs(btn.dataset.acc);
      const body = card.querySelector('.card-body');
      const open = !card.classList.contains('open');
      card.classList.toggle('open', open);
      body.style.display = open ? 'block':'none';
      btn.textContent = open ? '▾':'▸';
    });
  });

  // Toolbar filters
  qs('#btnHideComplete').addEventListener('click', e=>{
    document.body.classList.toggle('hide-complete');
    e.currentTarget.classList.toggle('ticked');
    e.currentTarget.textContent = document.body.classList.contains('hide-complete') ? 'Show Complete' : 'Hide Complete';
  });
  qs('#btnWatchingOnly').addEventListener('click', e=>{
    document.body.classList.toggle('watching-only');
    e.currentTarget.classList.toggle('ticked');
    e.currentTarget.textContent = document.body.classList.contains('watching-only') ? 'Show All' : 'Watching Only';
  });
  qs('#btnExpandAll').addEventListener('click', ()=>{
    qsa('.show-head').forEach(h=>{ if(h.getAttribute('aria-expanded')!=='true')  onShowToggle(h, h.parentElement, h.parentElement?.dataset.tmdbId); });
    qsa('.season-head').forEach(h=>{ if(h.getAttribute('aria-expanded')!=='true') toggleSeason(h); });
  });
  qs('#btnCollapseAll').addEventListener('click', ()=>{
    qsa('.season-head').forEach(h=>{ if(h.getAttribute('aria-expanded')!=='false') toggleSeason(h); });
    qsa('.show-head').forEach(h=>{ if(h.getAttribute('aria-expanded')!=='false')  onShowToggle(h, h.parentElement, h.parentElement?.dataset.tmdbId); });
  });

  // QA drawer toggle + stats render
  const qaBox = qs('#qaBox'); const qaHead = qs('#qaHead');
  qaBox.hidden = false;
  qaHead.addEventListener('click', ()=>{
    qaBox.classList.toggle('open');
    qaHead.textContent = qaBox.classList.contains('open') ? '▾ QA / Stats' : '▸ QA / Stats';
    if (qaBox.classList.contains('open') && gLastModel) fillQA();
  });
  qs('#btnQA').addEventListener('click', ()=>{
    qaBox.classList.add('open');
    qaHead.textContent = '▾ QA / Stats';
    if (gLastModel) fillQA();
  });

  // Delegated clicks: status + More/Less
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(btn){
      const row = e.target.closest('.episode-row, .movie-row');
      if(!row) return;
      const action = btn.dataset.action; // watching | watched | none
      if(row.classList.contains('episode-row')){
        const id = row.dataset.tmdbId, s = parseInt(row.dataset.season,10), ep = parseInt(row.dataset.ep,10);
        setStatus('episode', id, s, ep, action);
      }else{
        const id = row.dataset.tmdbId;
        setStatus('movie', id, null, null, action);
      }
      row.classList.remove('status-watching','status-watched','status-none');
      row.classList.add(`status-${action}`);
      return;
    }

    const more = e.target.closest('span.more');
    if(more){
      const row = qs('#'+more.dataset.more);
      const desc = row?.querySelector('.desc');
      if(desc){
        const open = !desc.classList.contains('open');
        desc.classList.toggle('open', open);
        more.textContent = open ? 'Less' : 'More';
      }
      return;
    }
  });

  // Wire Reload button
  qs('#btnReload').addEventListener('click', ()=> load(true, {showModal:true}));

  // Initial load
  load(false, {showModal:false});
}

function fillQA(){
  const stats = buildStats(gLastModel || {shows:new Map(), seasonsByShow:new Map(), movies:[]});
  const summary = [
    `Build: ${APP_VERSION}`,
    `Data:  ${gLastUsed || '(unknown)'}`,
    `Shows: ${stats.showCount}`,
    `Movies:${stats.movieCount}`,
    `Seasons total:  ${stats.totalSeasons}`,
    `Episodes total: ${stats.totalEpisodes}`
  ].join('\n');
  qs('#qaSummary').textContent = summary;

  const lines = stats.perShow.map(r => `- ${r.show}: seasons=${r.seasons}, episodes=${r.episodes}`);
  qs('#qaPerShow').textContent = lines.join('\n') || '(none)';

  qs('#qaTried').textContent = (gLastTried||[]).join('\n') || '(none)';
}

/* Main load with optional modal (same behavior as 4.2) */
async function load(force, opts={showModal:false}){
  const start = performance.now();
  const err = qs('#error'); err.textContent='';
  if (opts.showModal) modal.open();
  modal.log(`Load started ${new Date().toLocaleString()}`); modal.log(force ? 'Cache: reload' : 'Cache: no-store');

  const progress = (msg)=> modal.log(msg);
  const {text, tried, used, size, ms} = await fetchData(force, progress);
  gLastTried = tried || []; modal.setTimer(Math.round(performance.now()-start)); if (used) modal.setUrl(used);

  let diag = { build: APP_VERSION, used: used || null, tried: tried || [], fetchMs: ms || null, size: size || null, ok:false };
  if(!text){
    const m = 'Could not load data file.';
    err.textContent = m; modal.setError(m); gLastDiag = diag; return;
  }
  try{
    modal.log('Parsing data…');
    const model = parseDataFile(text);
    gLastText = text; gLastModel = model;
    renderAll(model, used);
    const stats = buildStats(model);
    modal.setCounts({ shows: stats.showCount, movies: stats.movieCount, seasons: stats.totalSeasons, episodes: stats.totalEpisodes });
    modal.log(`Parsed OK. Shows=${stats.showCount}, Movies=${stats.movieCount}, Seasons=${stats.totalSeasons}, Episodes=${stats.totalEpisodes}`);
    diag.ok = true; diag.stats = stats; gLastDiag = diag;
  }catch(e){
    console.error(e);
    err.textContent = 'Parse error: '+e.message;
    modal.setError('Parse error: '+e.message);
    diag.error = String(e.message || e); gLastDiag = diag;
  }
}

/* Utils */
function esc(s){
  return String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
