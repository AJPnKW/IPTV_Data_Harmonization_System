<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Boys Shows</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1a1a1a;
      color: #f0f0f0;
      margin: 20px;
      font-size: 1.2rem;
    }
    h1 {
      font-size: 2rem;
      text-align: center;
      color: #ffffff;
    }
    h2 {
      font-size: 1.5rem;
      color: #4CAF50;
      cursor: pointer;
      margin: 10px 0;
    }
    h3.show-title {
      font-size: 1.5rem;
      color: #2196F3;
      margin-left: 20px;
      cursor: pointer;
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
    }
    h3.show-title span.overview {
      font-size: 0.9rem;
      color: #bbb;
      margin-left: 10px;
    }
    h3.show-title span.source {
      font-size: 0.8rem;
      color: #fff;
      margin-left: 10px;
      background-color: #444;
      padding: 2px 5px;
      border-radius: 3px;
    }
    h3.season-title {
      font-size: 1.3rem;
      color: #4CAF50;
      margin-left: 20px;
      cursor: pointer;
    }
    .toggle {
      display: inline-block;
      width: 30px;
      height: 30px;
      text-align: center;
      background-color: #333;
      color: #fff;
      border-radius: 5px;
      margin-right: 10px;
      line-height: 30px;
      font-size: 1.5rem;
      user-select: none;
    }
    .toggle:focus { outline: 3px solid #ffeb3b; }
    .hidden { display: none; }
    .section-header {
      background-color: #222;
      font-weight: bold;
      padding: 5px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 5px 0;
      display: flex;
      flex-direction: column;
    }
    .data-table .header-row { display: flex; background-color: #333; }
    .data-table .data-row {
      display: flex;
      border-bottom: 1px solid #444;
    }
    .data-table .col {
      flex: 1;
      padding: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 80px;
    }
    .data-table .col.description {
      flex: 2;
      white-space: normal;
      word-wrap: break-word;
      min-width: 150px;
    }
    .data-table .show-row { background-color: #333; }
    .data-table .season-row { background-color: #444; }
    .data-table .episode-row, .data-table .movie-row { background-color: #555; }

    .status-buttons {
      white-space: nowrap;
      display: flex;
      gap: 5px;
    }
    .status-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      min-width: 80px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .status-btn:focus { outline: 3px solid #ffeb3b; }
    .status-btn.watching { background-color: #2196F3; color: white; }
    .status-btn.watched  { background-color: #4CAF50; color: white; }
    .status-btn.unmark   { background-color: #f44336; color: white; }

    .watching { background-color: rgba(33,150,243,0.1); }
    .watched  { background-color: rgba(76,175,80,0.1); }

    .watch-link {
      display: inline-block;
      padding: 3px 6px;
      background-color: #333;
      color: #fff;
      text-decoration: none;
      border-radius: 3px;
      font-size: 0.9rem;
      margin: 1px;
      white-space: nowrap;
    }
    .watch-link:hover, .watch-link:focus {
      background-color: #555;
      outline: 2px solid #ffeb3b;
    }

    .app-button {
      padding: 5px 10px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 5px;
    }

    .filter-toggles {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 5px 10px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .filter-btn.active { background-color: #4CAF50; }

    a, .toggle, h2, h3, .status-btn { outline: none; }
    a:focus, .toggle:focus, h2:focus, h3:focus, .status-btn:focus { outline: 3px solid #ffeb3b; }
  </style>
</head>
<body>
  <h1>The Boys Shows</h1>

  <!-- Filter Toggles -->
  <div class="filter-toggles">
    <button class="filter-btn" id="toggle-complete" onclick="toggleComplete()">Hide Complete</button>
    <button class="filter-btn" id="toggle-watched"  onclick="toggleWatched()">Show Watched + Watching</button>
  </div>

  <!-- Shows Section -->
  <h2 id="shows-toggle" tabindex="0" onclick="toggleSection('shows')"><span class="toggle">+</span> Shows</h2>
  <div id="shows" class="hidden"></div>

  <!-- Movies Section -->
  <h2 id="movies-toggle" tabindex="0" onclick="toggleSection('movies')"><span class="toggle">+</span> Movies</h2>
  <div id="movies" class="hidden"></div>

  <div id="error" style="color:#ff7878;margin-top:10px;"></div>

  <script>
    /* ===== BASE URLS ===== */
    const baseTmdbTv     = 'https://www.themoviedb.org/tv/';
    const baseTmdbMovie  = 'https://www.themoviedb.org/movie/';
    const baseVidSrcTv   = 'https://vidsrc.net/embed/tv/';
    const baseVidSrcMovie= 'https://vidsrc.net/embed/movie/';
    const baseMappleTv   = 'https://mapple.tv/watch/tv/';
    const baseMappleMovie= 'https://mapple.tv/watch/movie/';
    const baseNunFlixTv  = 'https://nunflix.cc/watch/tv/';
    const baseNunFlixMovie='https://nunflix.cc/watch/movie/';

    /* ===== SECTION TOGGLE (GLOBAL) ===== */
    window.toggleSection = function(id) {
      const section = document.getElementById(id);
      if (!section) return;
      const toggle = section.previousElementSibling?.querySelector('.toggle');
      const nowHidden = section.classList.toggle('hidden');
      if (toggle) toggle.textContent = nowHidden ? '+' : '–';
      section.previousElementSibling?.setAttribute('aria-expanded', String(!nowHidden));
    };

    /* ===== STATUS TOGGLE (GLOBAL) ===== */
    window.toggleStatus = function(entryId, action) {
      const row = document.getElementById(entryId);
      if (!row) return;
      const currentState = row.dataset.status || 'none';
      let newState = currentState;

      if (action === 'watching' && currentState !== 'watching') {
        newState = 'watching';
      } else if (action === 'watched' && currentState !== 'watched') {
        newState = 'watched';
      } else {
        newState = 'none';
      }

      row.dataset.status = newState;
      row.classList.remove('watching','watched');
      if (newState !== 'none') row.classList.add(newState);

      const buttonsCell = row.querySelector('.status-buttons');
      if (buttonsCell) {
        buttonsCell.innerHTML = '';
        if (newState === 'none') {
          buttonsCell.innerHTML += makeBtn(entryId,'watching','⏳ Mark Watching','watching');
          buttonsCell.innerHTML += makeBtn(entryId,'watched','✅ Mark Watched','watched');
        } else if (newState === 'watching') {
          buttonsCell.innerHTML += makeBtn(entryId,'none','❌ Unmark','unmark');
          buttonsCell.innerHTML += makeBtn(entryId,'watched','✅ Mark Watched','watched');
        } else if (newState === 'watched') {
          buttonsCell.innerHTML += makeBtn(entryId,'none','❌ Unmark','unmark');
          buttonsCell.innerHTML += makeBtn(entryId,'watching','⏳ Mark Watching','watching');
        }
      }
      localStorage.setItem('status-' + entryId, newState);
      applyFilters();
    };

    function makeBtn(entryId, action, label, extraClass) {
      const safeId = entryId.replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      return '<button class="status-btn ' + (extraClass||'') +
             '" onclick="toggleStatus(\'' + safeId + '\', \'' + action + '\')">' +
             label + '</button>';
    }

    /* ===== OPEN APP (GLOBAL) ===== */
    window.openApp = function(source, name) {
      let url = '';
      const isMobile = /iPad|iPhone|Android/i.test(navigator.userAgent);
      if (source === 'Netflix') {
        url = isMobile ? ('netflix://search?q=' + encodeURIComponent(name))
                       : ('https://www.netflix.com/search?q=' + encodeURIComponent(name));
      } else if (source === 'Prime Video') {
        url = isMobile ? ('amazonvideo://store/search?query=' + encodeURIComponent(name))
                       : ('https://www.amazon.com/gp/search?index=video&keywords=' + encodeURIComponent(name));
      }
      if (url) window.open(url, '_blank');
    };

    /* ===== FILTERS (GLOBAL) ===== */
    let hideComplete = true;           // default: hide watched
    let showWatchedWatching = true;    // default: include watched + watching

    window.toggleComplete = function() {
      hideComplete = !hideComplete;
      document.getElementById('toggle-complete').textContent =
        hideComplete ? 'Show Complete' : 'Hide Complete';
      applyFilters();
    };

    window.toggleWatched = function() {
      showWatchedWatching = !showWatchedWatching;
      document.getElementById('toggle-watched').textContent =
        showWatchedWatching ? 'Show Watching Only' : 'Show Watched + Watching';
      applyFilters();
    };

    function applyFilters() {
      document.querySelectorAll('.season-section, .episode-row, .movie-row').forEach(item => {
        const status = item.dataset.status || 'none';
        let hide = false;
        if (hideComplete && status === 'watched') hide = true;
        if (!showWatchedWatching && status !== 'watching') hide = true;
        item.style.display = hide ? 'none' : 'flex';
      });
    }

    /* ===== DATA LOAD / PARSE / RENDER ===== */
    document.addEventListener('DOMContentLoaded', loadData);

    function loadData() {
      const showsContainer  = document.getElementById('shows');
      const moviesContainer = document.getElementById('movies');
      showsContainer.innerHTML  =
        '<div class="section-header">Name | Date | Status | Source | Schedule</div><div class="data-table"></div>';
      moviesContainer.innerHTML =
        '<div class="section-header">Name | Release Date | Runtime | Overview | Streaming Source | VidSrc 📺 | Mapple 🌐 | NunFlix 🎬 | TBD ❓</div><div class="data-table"></div>';

      fetch('show_and_movie_data.tile.txt', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(text => {
          renderFromData(text);
          // Restore saved statuses
          document.querySelectorAll('[id^="episode-"], [id^="movie-"]').forEach(row => {
            const saved = localStorage.getItem('status-' + row.id);
            if (saved) window.toggleStatus(row.id, saved);
          });
          applyFilters();
        })
        .catch(err => {
          console.error('Error loading data:', err);
          document.getElementById('error').textContent =
            'Error loading data: ' + err.message +
            '. Ensure "show_and_movie_data.tile.txt" is in the same directory and formatted correctly.';
        });
    }

    function renderFromData(data) {
      const lines = data.split(/\r?\n/);
      let currentSection = null;
      let currentShowObj = null; // { tmdbId, name, safeShowId }

      const showsTable  = document.getElementById('shows').querySelector('.data-table');
      const moviesTable = document.getElementById('movies').querySelector('.data-table');

      for (let raw of lines) {
        if (!raw) continue;
        const line = raw.trim();
        if (!line || line.startsWith('#')) continue;

        if (line.startsWith('SHOWS'))  { currentSection = 'SHOWS';  continue; }
        if (line.startsWith('MOVIES')) { currentSection = 'MOVIES'; continue; }

        // Basic splitter; your file doesn’t use quoted pipes for these fields
        const parts = line.split('|').map(f => f.trim().replace(/\n/g,' '));
        const type = (parts[0] || '').toLowerCase();

        if (type === 'show') {
          // show|tmdb_id|name|overview|#_of_seasons|date|status|source|schedule|tmdb_url_link
          const [, tmdbId, name, overview, nSeasons, date, status, source, schedule] = parts;
          const safeShowId = (tmdbId + '-' + name).replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-');
          currentShowObj = { tmdbId, name, safeShowId };

          const showDiv = document.createElement('div');
          showDiv.className = 'show-section';
          showDiv.innerHTML =
            '<h3 class="show-title" id="show-' + safeShowId + '-toggle" tabindex="0">' +
              '<span class="toggle">+</span> ' + esc(name) +
              (overview ? ' <span class="overview">' + esc(overview) + '</span>' : '') +
              (source ? ' <span class="source">' + esc(source) + '</span>' : '') +
            '</h3>' +
            '<div id="show-' + safeShowId + '" class="hidden">' +
              '<div class="data-table">' +
                '<div class="header-row">' +
                  '<div class="col">Name</div>' +
                  '<div class="col">Date</div>' +
                  '<div class="col">Status</div>' +
                  '<div class="col">Source</div>' +
                  '<div class="col">Schedule</div>' +
                  '<div class="col">TMDB Link</div>' +
                '</div>' +
                '<div class="data-row show-row">' +
                  '<div class="col">' + esc(name) + '</div>' +
                  '<div class="col">' + esc(date || '') + '</div>' +
                  '<div class="col">' + esc(status || '') + '</div>' +
                  '<div class="col">' + esc(source || '') +
                    ((source === 'Netflix' || source === 'Prime Video')
                      ? (' <button class="app-button" onclick="openApp(\'' + escAttr(source) + '\', \'' + escAttr(name) + '\')">Open in App</button>')
                      : '') +
                  '</div>' +
                  '<div class="col">' + esc(schedule || '') + '</div>' +
                  '<div class="col"><a href="' + baseTmdbTv + encodeURIComponent(tmdbId) + '" class="watch-link" target="_blank" rel="noopener">TMDB</a></div>' +
                '</div>' +
              '</div>' +
            '</div>';

          showsTable.appendChild(showDiv);
          document.getElementById('show-' + safeShowId + '-toggle')
            .addEventListener('click', function() { window.toggleSection('show-' + safeShowId); });

        } else if (type === 'season' && currentShowObj) {
          // season|tmdb_id|seasonNum|year|overview|watchStatus
          const [, tmdbId, seasonNum, year, overview, watchStatus] = parts;
          const safeShowId = currentShowObj.safeShowId;

          const seasonDiv = document.createElement('div');
          seasonDiv.className = 'season-section';
          if (watchStatus) seasonDiv.dataset.status = watchStatus;

          seasonDiv.innerHTML =
            '<h3 class="season-title" id="show-' + safeShowId + '-season-' + seasonNum + '-toggle" tabindex="0">' +
              '<span class="toggle">+</span> Season ' + esc(seasonNum) + (year ? ' (' + esc(year) + ')' : '') +
              (overview ? ' • ' + esc(overview) : '') +
            '</h3>' +
            '<div id="show-' + safeShowId + '-season-' + seasonNum + '" class="hidden">' +
              '<div class="data-table">' +
                '<div class="header-row">' +
                  '<div class="col">Episode</div>' +
                  '<div class="col">Name</div>' +
                  '<div class="col">Date</div>' +
                  '<div class="col description">Description</div>' +
                  '<div class="col">Runtime</div>' +
                  '<div class="col">Streaming Source</div>' +
                  '<div class="col">VidSrc 📺</div>' +
                  '<div class="col">Mapple 🌐</div>' +
                  '<div class="col">NunFlix 🎬</div>' +
                  '<div class="col">TBD ❓</div>' +
                '</div>' +
              '</div>' +
            '</div>';

          const showBodyTable = document.getElementById('show-' + safeShowId).querySelector('.data-table');
          showBodyTable.appendChild(seasonDiv);

          document.getElementById('show-' + safeShowId + '-season-' + seasonNum + '-toggle')
            .addEventListener('click', function() { window.toggleSection('show-' + safeShowId + '-season-' + seasonNum); });

        } else if (type === 'episode' && currentShowObj) {
          // episode|tmdb_id|epNum|name|date|desc|runtime|source|vidSrc|mapple|nunFlix|tbd|watchStatus
          const [, tmdbId, epNum, name, date, desc, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus] = parts;
          // NOTE: By your file format, the current "season" context is the last declared season line.
          // We derive seasonNum from the last created season toggle id in this show block.
          const seasonToggles = document.querySelectorAll('h3.season-title[id^="show-' + currentShowObj.safeShowId + '-season-"]');
          if (!seasonToggles.length) continue; // no season yet
          const lastToggleId = seasonToggles[seasonToggles.length - 1].id; // show-<safe>-season-<N>-toggle
          const seasonNum = lastToggleId.replace(/^.*-season-/, '').replace(/-toggle$/,'');

          const safeShowId = currentShowObj.safeShowId;
          const rowId = 'episode-' + safeShowId + '-s' + seasonNum + '-e' + epNum;

          const resolvedVidSrc   = (vidSrc && vidSrc !== 'N/A') ? vidSrc : (baseVidSrcTv + encodeURIComponent(tmdbId) + '/' + encodeURIComponent(seasonNum) + '/' + encodeURIComponent(epNum));
          const resolvedMapple   = (mapple && mapple !== 'N/A') ? mapple : (baseMappleTv + encodeURIComponent(tmdbId) + '/' + encodeURIComponent(seasonNum) + '/' + encodeURIComponent(epNum));
          const resolvedNunFlix  = (nunFlix && nunFlix !== 'N/A') ? nunFlix : (baseNunFlixTv + encodeURIComponent(tmdbId) + '/' + encodeURIComponent(seasonNum) + '/' + encodeURIComponent(epNum));
          const resolvedTbd      = (tbd && tbd !== 'N/A') ? tbd : 'N/A';

          const epDiv = document.createElement('div');
          epDiv.className = 'episode-row data-row' + (watchStatus ? (' ' + watchStatus) : '');
          epDiv.id = rowId;
          if (watchStatus) epDiv.dataset.status = watchStatus;

          epDiv.innerHTML =
            '<div class="col">' + esc(epNum) + '</div>' +
            '<div class="col">' + esc(name || '') + '</div>' +
            '<div class="col">' + esc(date || '') + '</div>' +
            '<div class="col description">' + esc(desc || '') + '</div>' +
            '<div class="col">' + esc(runtime || '') + '</div>' +
            '<div class="col">' + esc(source || '') + '</div>' +
            '<div class="col"><a href="' + resolvedVidSrc  + '" class="watch-link" target="_blank" rel="noopener">📺</a></div>' +
            '<div class="col"><a href="' + resolvedMapple  + '" class="watch-link" target="_blank" rel="noopener">🌐</a></div>' +
            '<div class="col"><a href="' + resolvedNunFlix + '" class="watch-link" target="_blank" rel="noopener">🎬</a></div>' +
            '<div class="col"><a href="' + resolvedTbd     + '" class="watch-link" target="_blank" rel="noopener">❓</a></div>' +
            '<div class="status-buttons">' +
              makeBtn(rowId,'watching','⏳ Mark Watching','') +
              makeBtn(rowId,'watched','✅ Mark Watched','') +
            '</div>';

          document.getElementById('show-' + safeShowId + '-season-' + seasonNum)
            .querySelector('.data-table').appendChild(epDiv);

        } else if (type === 'movie') {
          // movie|tmdb_id|name|overview|releaseDate|rating|runtime|source|vidSrc|mapple|nunFlix|tbd|watchStatus
          const [, tmdbId, name, overview, releaseDate, rating, runtime, source, vidSrc, mapple, nunFlix, tbd, watchStatus] = parts;
          const safeId = (tmdbId + '-' + name).replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-');
          const rowId  = 'movie-' + safeId;

          const resolvedVidSrc   = (vidSrc && vidSrc !== 'N/A') ? vidSrc : (baseVidSrcMovie + encodeURIComponent(tmdbId));
          const resolvedMapple   = (mapple && mapple !== 'N/A') ? mapple : (baseMappleMovie + encodeURIComponent(tmdbId));
          const resolvedNunFlix  = (nunFlix && nunFlix !== 'N/A') ? nunFlix : (baseNunFlixMovie + encodeURIComponent(tmdbId));
          const resolvedTbd      = (tbd && tbd !== 'N/A') ? tbd : 'N/A';

          const movieDiv = document.createElement('div');
          movieDiv.className = 'movie-section';
          movieDiv.innerHTML =
            '<div class="data-table">' +
              '<div class="header-row">' +
                '<div class="col">Name</div>' +
                '<div class="col">Release Date</div>' +
                '<div class="col">Runtime</div>' +
                '<div class="col description">Overview</div>' +
                '<div class="col">Streaming Source</div>' +
                '<div class="col">VidSrc 📺</div>' +
                '<div class="col">Mapple 🌐</div>' +
                '<div class="col">NunFlix 🎬</div>' +
                '<div class="col">TBD ❓</div>' +
              '</div>' +
              '<div id="' + rowId + '" class="movie-row data-row' + (watchStatus ? (' ' + watchStatus) : '') + '"' +
                   (watchStatus ? (' data-status="' + escAttr(watchStatus) + '"') : '') + '>' +
                '<div class="col">' + esc(name) + '</div>' +
                '<div class="col">' + esc(releaseDate || '') + '</div>' +
                '<div class="col">' + esc(runtime || '') + '</div>' +
                '<div class="col description">' + esc(overview || '') + '</div>' +
                '<div class="col">' + esc(source || '') +
                  ((source === 'Netflix' || source === 'Prime Video')
                    ? (' <button class="app-button" onclick="openApp(\'' + escAttr(source) + '\', \'' + escAttr(name) + '\')">Open in App</button>')
                    : '') +
                '</div>' +
                '<div class="col"><a href="' + resolvedVidSrc  + '" class="watch-link" target="_blank" rel="noopener">📺</a></div>' +
                '<div class="col"><a href="' + resolvedMapple  + '" class="watch-link" target="_blank" rel="noopener">🌐</a></div>' +
                '<div class="col"><a href="' + resolvedNunFlix + '" class="watch-link" target="_blank" rel="noopener">🎬</a></div>' +
                '<div class="col"><a href="' + resolvedTbd     + '" class="watch-link" target="_blank" rel="noopener">❓</a></div>' +
                '<div class="status-buttons">' +
                  makeBtn(rowId,'watching','⏳ Mark Watching','') +
                  makeBtn(rowId,'watched','✅ Mark Watched','') +
                '</div>' +
              '</div>' +
            '</div>';

          moviesTable.appendChild(movieDiv);
        }
      }
    }

    /* ===== HELPERS ===== */
    function esc(s) {
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
    function escAttr(s) {
      return String(s ?? '').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
