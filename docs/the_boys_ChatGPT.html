<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Boys Shows ‚Ä¢ ChatGPT Light UI (TBS-LITE-2.1)</title>

<!--
  the_boys_ChatGPT.html  (Light/Teal UI, robust loader)
  Purpose: Readable catalog with show‚Üíseason‚Üíepisode accordions, responsive tables, high contrast, and persistent status.
  Data:    ./show_and_movie_data.tile.txt (same folder) OR ?data=<absolute/relative URL>
  Version: 2025-10-16  |  Doc ID: TBS-LITE-2.1
-->

<style>
  :root{
    --page-bg: #f7f9fb;
    --card-bg: #ffffff;
    --row-even: #ffffff;
    --row-odd:  #f3f6f8;
    --border:   #d7dde6;
    --text:     #1f2937;
    --muted:    #5b6573;
    --teal:     #1aa39a;
    --teal-dark:#16867f;
    --teal-faint:#e3f4f3;
    --link:     #0b6bcf;
    --focus:    #ffd54f;
    --ok:       #2e7d32;
    --info:     #1976d2;
    --danger:   #c62828;
  }

  html,body{
    background:var(--page-bg);
    color:var(--text);
    margin:0;
    font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
  }

  .container{ max-width:1280px; margin:24px auto 64px; padding:0 16px; }
  header.app{ text-align:center; margin-bottom:12px; }
  .title{ font-weight:800; letter-spacing:.2px; font-size: clamp(22px, 2.4vw, 30px); margin:0 0 8px; }

  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:6px;
  }
  .btn{
    appearance:none; border:1px solid var(--border);
    background:var(--card-bg); color:var(--text);
    padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:700;
  }
  .btn.ticked{ border-color: var(--teal); box-shadow: 0 0 0 2px var(--teal-faint) inset; }
  .btn:focus{ outline:3px solid var(--focus); outline-offset:2px; }

  .card{
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:14px; overflow:hidden; box-shadow: 0 2px 10px rgba(16,24,40,0.05); margin-top:16px;
  }
  .card-strip{
    background:var(--teal); color:#fff; padding:12px 14px;
    display:flex; align-items:center; gap:10px; font-weight:800;
  }
  .chev{
    width:28px; height:28px; display:inline-grid; place-items:center;
    border-radius:6px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.35);
    cursor:pointer; user-select:none; font-weight:800;
  }
  .badge{ margin-left:auto; background:rgba(255,255,255,.16); padding:4px 10px; border-radius:999px; font-weight:700; }
  .card-body{ padding:8px 10px 12px; display:none; }
  .card.open .card-body{ display:block; }

  .show{ border:1px solid var(--border); border-radius:12px; overflow:hidden; margin:10px 0; background:var(--card-bg); }
  .show-head{
    display:grid; grid-template-columns: 24px 1fr auto; align-items:center; column-gap:10px;
    padding:10px 12px; background:#ecf6f5; border-bottom:1px solid var(--border); cursor:pointer;
  }
  .show-head .name{ font-weight:800; color:#0a4e4a; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .chip{ background:#eef2f7; color:var(--muted); border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .show-body{ display:none; padding: 8px 10px 12px; }

  .season{ border:1px solid var(--border); border-radius:10px; overflow:hidden; margin:10px 4px; background:var(--card-bg); }
  .season-head{
    display:flex; align-items:center; gap:12px; padding:10px 12px; background:#e7f1f0; border-bottom:1px solid var(--border);
    cursor:pointer; font-weight:800; color:#0c605a;
  }
  .season-sub{ color:var(--muted); font-weight:600; margin-left:auto; font-size:13px; }

  .table{ width:100%; border-collapse:separate; border-spacing:0; }
  .thead{ position:sticky; top:0; z-index:1; background:#e2efee; }

  .row{
    display:grid;
    grid-template-columns: 64px 1.2fr 140px 100px minmax(220px,2fr) 140px 96px 96px 96px 70px 230px;
    align-items:center;
  }
  .cell,.head{ padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .head{ font-weight:800; color:#0a4e4a; }
  .cell.wrap{ white-space:normal; }
  .tbody .row:nth-child(odd){ background:var(--row-odd); }
  .tbody .row:nth-child(even){ background:var(--row-even); }

  .row.movie{ grid-template-columns: 1.6fr 140px 100px minmax(260px,2fr) 150px 96px 96px 96px 70px 230px; }

  .desc{ max-height: 1.6em; overflow:hidden; text-overflow:ellipsis; }
  .desc.open{ max-height:none; white-space:normal; }
  .more{ margin-left:8px; font-weight:800; color:var(--link); cursor:pointer; }

  .btn-mini{
    border:1px solid var(--border); background:#eef2f7; color:#0f172a;
    border-radius:8px; padding:6px 8px; cursor:pointer; font-weight:800; font-size:13px; margin-right:6px;
  }
  .btn-mini.ok{   background:#e6f4ea; color:var(--ok);   border-color:#b9e0c0; }
  .btn-mini.info{ background:#e6f0fb; color:var(--info); border-color:#c7d5f5; }
  .btn-mini.dang{ background:#fdeaea; color:var(--danger); border-color:#f3b8b8; }
  .btn-mini:focus{ outline:3px solid var(--focus); outline-offset:2px; }

  a.link{ color:var(--link); text-decoration:none; border-bottom:1px dotted #9ec5ff; }
  a.link:focus{ outline:3px solid var(--focus); outline-offset:2px; }
  .status-dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; display:inline-block; border:1px solid var(--border); }
  .is-watching .status-dot{ background:#64b5f6; }
  .is-watched  .status-dot{ background:#81c784; }

  @media (max-width: 1100px){
    .row{ grid-template-columns: 56px 1.2fr 128px 90px minmax(180px,2fr) 130px 90px 90px 90px 64px 200px; }
    .row.movie{ grid-template-columns: 1.3fr 125px 90px minmax(210px,2fr) 140px 90px 90px 90px 64px 200px; }
  }
  @media (max-width: 860px){
    .chips{ display:none; }
    .row{ grid-template-columns: 48px 1.2fr 118px 80px minmax(160px,2fr) 110px 84px 84px 84px 60px 190px; }
    .row.movie{ grid-template-columns: 1.1fr 115px 84px minmax(190px,2fr) 130px 84px 84px 84px 60px 190px; }
  }
  @media (max-width: 700px){
    .row{ grid-template-columns: 44px 1fr 110px 76px minmax(150px,2fr) 0px 80px 80px 80px 56px 160px; }
    .row .cell:nth-child(6){ display:none; } /* hide 'Source' on small screens */
    .row.movie{ grid-template-columns: 1fr 108px 76px minmax(180px,2fr) 0px 80px 80px 80px 56px 160px; }
    .row.movie .cell:nth-child(5){ display:none; }
  }
</style>
</head>
<body>
  <div class="container">
    <header class="app">
      <h1 class="title">The Boys Shows</h1>
      <div class="toolbar" role="toolbar" aria-label="filters and actions">
        <button class="btn" id="btnHideComplete" aria-pressed="false">Hide Complete</button>
        <button class="btn" id="btnWatchingOnly" aria-pressed="false">Watching Only</button>
        <button class="btn" id="btnExpandAll"  aria-pressed="false">Expand All</button>
        <button class="btn" id="btnCollapseAll" aria-pressed="false">Collapse All</button>
        <button class="btn" id="btnReload" aria-pressed="false">Reload Data</button>
      </div>
    </header>

    <!-- Shows -->
    <section class="card" id="cardShows">
      <div class="card-strip">
        <button class="chev" data-acc="#cardShows">‚ñ∏</button>
        Shows
        <span class="badge" id="showsCount">‚Ä¶</span>
      </div>
      <div class="card-body" id="showsBody"></div>
    </section>

    <!-- Movies -->
    <section class="card" id="cardMovies">
      <div class="card-strip">
        <button class="chev" data-acc="#cardMovies">‚ñ∏</button>
        Movies
        <span class="badge" id="moviesCount">‚Ä¶</span>
      </div>
      <div class="card-body" id="moviesBody"></div>
    </section>

    <p id="err" style="color:#b00020; margin-top:12px;"></p>
  </div>

<script>
/* =================== Config =================== */
const DEFAULT_FILE = 'show_and_movie_data.tile.txt';
const ALT_FILE     = 'show_and_movie_data.txt';
const NS = 'ajp.lite';  // localStorage namespace

const L = {
  tmdbTv  : (id) => `https://www.themoviedb.org/tv/${encodeURIComponent(id)}`,
  tmdbMov : (id) => `https://www.themoviedb.org/movie/${encodeURIComponent(id)}`,
  vidsTv  : (id,s,e) => `https://vidsrc.net/embed/tv/${encodeURIComponent(id)}/${encodeURIComponent(s)}/${encodeURIComponent(e)}`,
  vidsMov : (id) => `https://vidsrc.net/embed/movie/${encodeURIComponent(id)}`,
  mapTv   : (id,s,e) => `https://mapple.tv/watch/tv/${encodeURIComponent(id)}/${encodeURIComponent(s)}/${encodeURIComponent(e)}`,
  mapMov  : (id) => `https://mapple.tv/watch/movie/${encodeURIComponent(id)}`,
  nunTv   : (id,s,e) => `https://nunflix.cc/watch/tv/${encodeURIComponent(id)}/${encodeURIComponent(s)}/${encodeURIComponent(e)}`,
  nunMov  : (id) => `https://nunflix.cc/watch/movie/${encodeURIComponent(id)}`
};

/* =================== Utils ==================== */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const esc = (s)=> String(s ?? '')
  .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
  .replaceAll('"','&quot;').replaceAll("'","&#39;');

const key = (type,id,season,ep)=> [NS,type,id,season??'',ep??''].filter(Boolean).join('.');
function setStatus(type,id,s,e,val){ localStorage.setItem(key(type,id,s,e), val); }
function getStatus(type,id,s,e){ return localStorage.getItem(key(type,id,s,e)) || 'none'; }

function splitPipes(line){
  // supports "quoted|segments"
  const out=[]; let cur='',q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ q=!q; continue; }
    if(ch==='|' && !q){ out.push(cur); cur=''; } else cur+=ch;
  }
  out.push(cur);
  return out.map(s=>s.replace(/\\n/g,'\n').trim());
}

/* =================== Robust Loader ==================== */
/* Tries multiple candidate URLs so GH Pages / local / docs/ all work */
async function fetchFirst(urls, force=false){
  const tried = [];
  for(const u of [...new Set(urls)]){
    try{
      const r = await fetch(u, {cache: force?'reload':'no-store'});
      tried.push({url:u, status:r.status});
      if(r.ok){
        const text = await r.text();
        if(text && text.trim().length>0) return {text, used:u, tried};
      }
    }catch(e){
      tried.push({url:u, status:'ERR'});
    }
  }
  return {text:null, used:null, tried};
}

function candidateURLs(){
  const q = new URLSearchParams(location.search).get('data');
  if(q) return [q];

  const here = location.href;
  const baseDir = here.substring(0, here.lastIndexOf('/')+1);
  const parts = location.pathname.split('/').filter(Boolean); // /user.github.io/<repo>/file
  const repoBase = parts.length>=1 ? `/${parts[0]}/` : '/';

  return [
    DEFAULT_FILE,                       // same folder
    ALT_FILE,                           // alt filename
    baseDir + DEFAULT_FILE,             // absolute to current doc
    baseDir + ALT_FILE,
    repoBase + DEFAULT_FILE,            // site root + file
    repoBase + ALT_FILE,
    './docs/' + DEFAULT_FILE,           // try docs/
    './docs/' + ALT_FILE,
    repoBase + 'docs/' + DEFAULT_FILE,
    repoBase + 'docs/' + ALT_FILE
  ];
}

/* =================== Parse ==================== */
function parse(text){
  const shows=new Map(); const movies=[];
  let currentShow=null, lastSeason=null;

  for(const raw of text.split(/\r?\n/)){
    const line=raw.trim();
    if(!line || line.startsWith('#')) continue;

    // Section markers (optional, ignored otherwise)
    if(line.toUpperCase()==='SHOWS' || line.toUpperCase()==='MOVIES') continue;

    const f=splitPipes(line);
    const type=(f[0]||'').toLowerCase();

    if(type==='show'){
      // show|tmdb_id|name|overview|#_of_seasons|date|status|source|schedule|tmdb_url_link
      const [, id, name, overview, nSeasons, date, status, source, schedule, tmdb] = f;
      currentShow = { id, name, overview, nSeasons, date, status, source, schedule, tmdb: tmdb || L.tmdbTv(id), seasons:new Map() };
      shows.set(id,currentShow); lastSeason=null;
    } else if(type==='season' && currentShow){
      // season|tmdb_id|seasonNum|year|overview|watchStatus
      const [, sid, num, year, overview, watchStatus] = f;
      if(sid!==currentShow.id) continue;
      lastSeason={ num:String(num), year, overview, watchStatus, episodes:[] };
      currentShow.seasons.set(String(num), lastSeason);
    } else if(type==='episode' && currentShow && lastSeason){
      // episode|tmdb_id|epNum|name|date|desc|runtime|source|vidSrc|mapple|nunFlix|tbd|watchStatus
      const [, sid, epNum, name, date, desc, runtime, source, vidSrc, mapple, nun, tbd, watchStatus]=f;
      if(sid!==currentShow.id) continue;
      lastSeason.episodes.push({
        epNum, name, date, desc, runtime, source,
        links:{
          vids:(vidSrc && vidSrc!=='N/A') ? vidSrc : L.vidsTv(sid, lastSeason.num, epNum),
          map :(mapple && mapple!=='N/A') ? mapple : L.mapTv(sid, lastSeason.num, epNum),
          nun :(nun && nun!=='N/A') ? nun : L.nunTv(sid, lastSeason.num, epNum),
          tbd :(tbd && tbd!=='N/A') ? tbd : null
        },
        watchStatus
      });
    } else if(type==='movie'){
      // movie|tmdb_id|name|overview|releaseDate|rating|runtime|source|vidSrc|mapple|nunFlix|tbd|watchStatus
      const [, id, name, overview, releaseDate, rating, runtime, source, vidSrc, mapple, nun, tbd, watchStatus]=f;
      movies.push({
        id, name, overview, releaseDate, rating, runtime, source,
        links:{
          vids:(vidSrc && vidSrc!=='N/A') ? vidSrc : L.vidsMov(id),
          map :(mapple && mapple!=='N/A') ? mapple : L.mapMov(id),
          nun :(nun && nun!=='N/A') ? nun : L.nunMov(id),
          tbd :(tbd && tbd!=='N/A') ? tbd : null
        },
        watchStatus
      });
    }
  }
  return {shows, movies};
}

/* =================== Render =================== */
function renderAll(model){
  renderShows(model);
  renderMovies(model);
  restoreStates();
  applyFilters();
  // open both sections after first successful render
  toggleCard('#cardShows', true);
  toggleCard('#cardMovies', true);
}

function renderShows({shows}){
  const body = $('#showsBody'); body.innerHTML='';
  $('#showsCount').textContent = String(shows.size);

  for(const show of shows.values()){
    const wrap = document.createElement('div');
    wrap.className='show';

    const showBodyId = `show-${show.id}`;
    wrap.innerHTML = `
      <div class="show-head" data-toggle="#${showBodyId}" tabindex="0" role="button" aria-expanded="false">
        <span class="chev" aria-hidden="true">‚ñ∏</span>
        <div class="name">${esc(show.name)}</div>
        <div class="chips">
          ${show.date ? `<span class="chip">${esc(show.date)}</span>`:''}
          ${show.status ? `<span class="chip">${esc(show.status)}</span>`:''}
          ${show.source ? `<span class="chip">${esc(show.source)}</span>`:''}
          ${show.schedule ? `<span class="chip">${esc(show.schedule)}</span>`:''}
          <a class="link" href="${show.tmdb}" target="_blank" rel="noopener">TMDB</a>
        </div>
      </div>
      <div class="show-body" id="${showBodyId}"></div>
    `;
    body.appendChild(wrap);

    const host = $('#'+showBodyId);
    const seasons = [...show.seasons.values()].sort((a,b)=>Number(a.num)-Number(b.num));
    for(const s of seasons){
      const seasonId = `tbl-${show.id}-${s.num}`;
      const season = document.createElement('div');
      season.className='season';
      season.innerHTML = `
        <div class="season-head" data-toggle="#${seasonId}" tabindex="0" role="button" aria-expanded="false">
          <span class="chev" aria-hidden="true">‚ñ∏</span>
          <div>Season ${esc(s.num)} ${s.year?`(${esc(s.year)})`:''}</div>
          <div class="season-sub">${esc(s.overview||'')}</div>
        </div>
        <div id="${seasonId}" style="display:none;">
          ${renderEpisodeTable(show.id, s)}
        </div>
      `;
      host.appendChild(season);
    }
  }
}

function renderEpisodeTable(showId, s){
  const rows = s.episodes.slice().sort((a,b)=>Number(a.epNum)-Number(b.epNum)).map(ep=>{
    const saved = getStatus('ep', showId, s.num, ep.epNum) || ep.watchStatus || 'none';
    const cls = saved==='watched' ? 'is-watched' : (saved==='watching' ? 'is-watching' : '');
    const rowId = `ep-${showId}-${s.num}-${ep.epNum}`;
    const tbd = ep.links.tbd ? `<a class="link" href="${ep.links.tbd}" target="_blank" rel="noopener">‚ùì</a>` : '‚Äî';

    return `
      <div class="row ${cls}" id="${rowId}" data-type="ep" data-show="${showId}" data-season="${s.num}" data-ep="${ep.epNum}" data-status="${saved}">
        <div class="cell">#${esc(ep.epNum)}</div>
        <div class="cell">${esc(ep.name||'')}</div>
        <div class="cell">${esc(ep.date||'')}</div>
        <div class="cell">${esc(ep.runtime||'')}</div>
        <div class="cell">
          <span class="desc">${esc(ep.desc||'')}</span>
          <span class="more" data-more="${rowId}">More</span>
        </div>
        <div class="cell">${esc(ep.source||'')}</div>
        <div class="cell"><a class="link" href="${ep.links.vids}" target="_blank" rel="noopener">üì∫ VidSrc</a></div>
        <div class="cell"><a class="link" href="${ep.links.map}"  target="_blank" rel="noopener">üåê Mapple</a></div>
        <div class="cell"><a class="link" href="${ep.links.nun}"  target="_blank" rel="noopener">üé¨ NunFlix</a></div>
        <div class="cell">${tbd}</div>
        <div class="cell">${btnSet(rowId, saved)}</div>
      </div>
    `;
  }).join('');

  return `
    <div class="table" role="table" aria-label="Episodes">
      <div class="thead row" role="row">
        <div class="head" role="columnheader">#</div>
        <div class="head" role="columnheader">Title</div>
        <div class="head" role="columnheader">Date</div>
        <div class="head" role="columnheader">Length</div>
        <div class="head" role="columnheader">Description</div>
        <div class="head" role="columnheader">Source</div>
        <div class="head" role="columnheader">VidSrc</div>
        <div class="head" role="columnheader">Mapple</div>
        <div class="head" role="columnheader">NunFlix</div>
        <div class="head" role="columnheader">TBD</div>
        <div class="head" role="columnheader">Status</div>
      </div>
      <div class="tbody">${rows}</div>
    </div>
  `;
}

function btnSet(id, state){
  if(state==='watched'){
    return `
      <button class="btn-mini dang" data-action="none" data-target="${id}">‚ùå Unmark</button>
      <button class="btn-mini info" data-action="watching" data-target="${id}">‚è≥ Watching</button>
    `;
  } else if(state==='watching'){
    return `
      <button class="btn-mini ok" data-action="watched" data-target="${id}">‚úÖ Watched</button>
      <button class="btn-mini dang" data-action="none" data-target="${id}">‚ùå Unmark</button>
    `;
  } else {
    return `
      <button class="btn-mini info" data-action="watching" data-target="${id}">‚è≥ Watching</button>
      <button class="btn-mini ok" data-action="watched" data-target="${id}">‚úÖ Watched</button>
    `;
  }
}

function renderMovies({movies}){
  const body=$('#moviesBody'); body.innerHTML='';
  $('#moviesCount').textContent = String(movies.length);

  const rows = movies.map(m=>{
    const saved = getStatus('movie', m.id) || m.watchStatus || 'none';
    const cls = saved==='watched' ? 'is-watched' : (saved==='watching' ? 'is-watching' : '');
    const id = `mov-${m.id}`;
    const tbd = m.links.tbd ? `<a class="link" href="${m.links.tbd}" target="_blank" rel="noopener">‚ùì</a>` : '‚Äî';

    return `
      <div class="row movie ${cls}" id="${id}" data-type="movie" data-id="${m.id}" data-status="${saved}">
        <div class="cell"><a class="link" href="${L.tmdbMov(m.id)}" target="_blank" rel="noopener">${esc(m.name)}</a></div>
        <div class="cell">${esc(m.releaseDate||'')}</div>
        <div class="cell">${esc(m.runtime||'')}</div>
        <div class="cell"><span class="desc">${esc(m.overview||'')}</span><span class="more" data-more="${id}">More</span></div>
        <div class="cell">${esc(m.source||'')}</div>
        <div class="cell"><a class="link" href="${m.links.vids}" target="_blank" rel="noopener">üì∫</a></div>
        <div class="cell"><a class="link" href="${m.links.map}"  target="_blank" rel="noopener">üåê</a></div>
        <div class="cell"><a class="link" href="${m.links.nun}"  target="_blank" rel="noopener">üé¨</a></div>
        <div class="cell">${tbd}</div>
        <div class="cell">${btnSet(id, saved)}</div>
      </div>
    `;
  }).join('');

  const table = document.createElement('div');
  table.className='table';
  table.setAttribute('role','table');
  table.innerHTML = `
    <div class="thead row">
      <div class="head">Title</div><div class="head">Release</div><div class="head">Length</div>
      <div class="head">Overview</div><div class="head">Source</div><div class="head">VidSrc</div>
      <div class="head">Mapple</div><div class="head">NunFlix</div><div class="head">TBD</div><div class="head">Status</div>
    </div>
    <div class="tbody">${rows}</div>
  `;
  body.appendChild(table);
}

/* =================== Interactions =================== */
function applyFilters(){
  const hideComplete = $('#btnHideComplete').dataset.on==='1';
  const watchingOnly = $('#btnWatchingOnly').dataset.on==='1';

  $$('.row.movie, .tbody .row').forEach(r=>{
    const st = r.dataset.status || 'none';
    let show = true;
    if(hideComplete && st==='watched') show=false;
    if(watchingOnly && st!=='watching') show=false;
    r.style.display = show ? 'grid' : 'none';
  });

  // hide season shells if all children hidden
  $$('.season').forEach(season=>{
    const tbody = season.querySelector('.tbody');
    if(!tbody) return;
    const any = $$('.row', tbody).some(r => r.style.display !== 'none');
    season.style.display = any ? 'block' : 'none';
  });
}

function restoreStates(){
  $$('.row[data-type="ep"], .row.movie').forEach(row=>{
    const type=row.dataset.type;
    let saved='none';
    if(type==='ep') saved=getStatus('ep', row.dataset.show, row.dataset.season, row.dataset.ep);
    else            saved=getStatus('movie', row.dataset.id);
    if(saved && saved!=='none') setRowState(row, saved, false);
  });
}

function setRowState(row, state, persist=true){
  row.dataset.status = state;
  row.classList.toggle('is-watched',  state==='watched');
  row.classList.toggle('is-watching', state==='watching');
  const id=row.id;
  const lastCell = row.lastElementChild;
  if(lastCell) lastCell.innerHTML = btnSet(id, state);
  if(persist){
    if(row.dataset.type==='ep'){
      setStatus('ep', row.dataset.show, row.dataset.season, row.dataset.ep, state);
    }else{
      setStatus('movie', row.dataset.id, null, null, state);
    }
  }
  applyFilters();
}

function toggleCard(sel, open){
  const card=$(sel); if(!card) return;
  const body=card.querySelector('.card-body');
  const btn = card.querySelector('.card-strip .chev');
  const willOpen = open!=null ? open : !card.classList.contains('open');
  card.classList.toggle('open', willOpen);
  if(btn) btn.textContent = willOpen ? '‚ñæ' : '‚ñ∏';
  if(body) body.style.display = willOpen ? 'block' : 'none';
}

/* =================== Boot =================== */
function init(){
  // Card accordions
  $$('.card .card-strip .chev').forEach(b=>{
    b.addEventListener('click', e => toggleCard(e.currentTarget.dataset.acc));
  });

  // Toolbar toggles
  $('#btnHideComplete').addEventListener('click', e=>{
    const b=e.currentTarget; b.dataset.on = b.dataset.on==='1'?'0':'1';
    b.classList.toggle('ticked', b.dataset.on==='1');
    b.textContent = b.dataset.on==='1' ? 'Show Complete' : 'Hide Complete';
    applyFilters();
  });
  $('#btnWatchingOnly').addEventListener('click', e=>{
    const b=e.currentTarget; b.dataset.on = b.dataset.on==='1'?'0':'1';
    b.classList.toggle('ticked', b.dataset.on==='1');
    b.textContent = b.dataset.on==='1' ? 'Show All' : 'Watching Only';
    applyFilters();
  });
  $('#btnExpandAll').addEventListener('click', ()=>{
    // open every show & every season
    $$('.show-head').forEach(h=>{ if($(h.dataset.toggle)?.style.display!=='block'){ h.click(); } });
    $$('.season-head').forEach(h=>{ if($(h.dataset.toggle)?.style.display!=='block'){ h.click(); } });
  });
  $('#btnCollapseAll').addEventListener('click', ()=>{
    $$('.season-head').forEach(h=>{ if($(h.dataset.toggle)?.style.display!=='none'){ h.click(); } });
    $$('.show-head').forEach(h=>{ if($(h.dataset.toggle)?.style.display!=='none'){ h.click(); } });
  });
  $('#btnReload').addEventListener('click', ()=> loadData(true));

  // Delegated clicks (show/season/row actions)
  document.addEventListener('click', (e)=>{
    const t=e.target;

    // Show toggle
    const showHead = t.closest('.show-head');
    if(showHead){
      const id = showHead.dataset.toggle;
      const el = $(id);
      const open = el && el.style.display!=='block';
      if(el){ el.style.display = open ? 'block':'none'; }
      const chev = showHead.querySelector('.chev'); if(chev) chev.textContent = open ? '‚ñæ':'‚ñ∏';
      showHead.setAttribute('aria-expanded', String(open));
      return;
    }

    // Season toggle
    const seasonHead = t.closest('.season-head');
    if(seasonHead){
      const id = seasonHead.dataset.toggle;
      const el = $(id);
      const open = el && el.style.display!=='block';
      if(el){ el.style.display = open ? 'block':'none'; }
      const chev = seasonHead.querySelector('.chev'); if(chev) chev.textContent = open ? '‚ñæ':'‚ñ∏';
      seasonHead.setAttribute('aria-expanded', String(open));
      return;
    }

    // More/less for description
    const more = t.closest('.more');
    if(more){
      const rid = more.dataset.more;
      const row = document.getElementById(rid);
      if(!row) return;
      const d = row.querySelector('.desc');
      if(!d) return;
      const open = !d.classList.contains('open');
      d.classList.toggle('open', open);
      more.textContent = open ? 'Less' : 'More';
      return;
    }

    // Status buttons
    const btn = t.closest('[data-action][data-target]');
    if(btn){
      const row = document.getElementById(btn.dataset.target);
      if(!row) return;
      const action = btn.dataset.action; // watching | watched | none
      const newState = action==='none' ? 'none' : action;
      setRowState(row, newState, true);
      return;
    }
  });

  // Keyboard toggle (Enter)
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    const sh = e.target.closest('.show-head');
    const se = e.target.closest('.season-head');
    if(sh) sh.click();
    if(se) se.click();
  });

  loadData(false);
}

async function loadData(force){
  $('#err').textContent='';
  $('#showsCount').textContent='‚Ä¶';
  $('#moviesCount').textContent='‚Ä¶';

  const urls = candidateURLs();
  const {text, used, tried} = await fetchFirst(urls, force);

  if(!text){
    const list = tried.map(t => `‚Ä¢ ${t.url}  [${t.status}]`).join('\n');
    $('#err').innerHTML =
      'Could not load data file. Tried:<br><pre style="white-space:pre-wrap;background:#fff;border:1px solid #eee;padding:8px;border-radius:8px;">'+
      esc(list) + '</pre>' +
      'Tip: ensure the data file sits next to this HTML or pass <code>?data=/IPTV_Data_Harmonization_System/show_and_movie_data.tile.txt</code> in the URL.';
    $('#showsCount').textContent='0';
    $('#moviesCount').textContent='0';
    $('#showsBody').innerHTML='';
    $('#moviesBody').innerHTML='';
    return;
  }

  try{
    const model = parse(text);
    renderAll(model);
  }catch(e){
    console.error(e);
    $('#err').textContent = 'Parse error: '+e.message;
    $('#showsCount').textContent='0';
    $('#moviesCount').textContent='0';
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
